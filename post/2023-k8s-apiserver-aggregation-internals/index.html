<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ææ‡‚ K8s apiserver aggregation - ZengXu&#39;s BLOG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zeng Xu" /><meta name="description" content="understanding apiserver aggregation in Kuberntes" /><meta name="keywords" content="kubernetes" />






<meta name="generator" content="Hugo 0.109.0 with theme even" />


<link rel="canonical" href="https://www.zeng.dev/post/2023-k8s-apiserver-aggregation-internals/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.3ab191e0444a0833d62fa8f1e44231fc793f2c04a2474a8b9348894c550f8388.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="ææ‡‚ K8s apiserver aggregation" />
<meta property="og:description" content="understanding apiserver aggregation in Kuberntes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zeng.dev/post/2023-k8s-apiserver-aggregation-internals/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-05-31T18:46:31+08:00" />
<meta property="article:modified_time" content="2023-05-31T18:46:31+08:00" />
<meta itemprop="name" content="ææ‡‚ K8s apiserver aggregation">
<meta itemprop="description" content="understanding apiserver aggregation in Kuberntes"><meta itemprop="datePublished" content="2023-05-31T18:46:31+08:00" />
<meta itemprop="dateModified" content="2023-05-31T18:46:31+08:00" />
<meta itemprop="wordCount" content="3259">
<meta itemprop="keywords" content="kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ææ‡‚ K8s apiserver aggregation"/>
<meta name="twitter:description" content="understanding apiserver aggregation in Kuberntes"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">ä¸»é¡µ</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">
        <li class="mobile-menu-item">æ‚æ–‡</li>
      </a><a href="/about">
        <li class="mobile-menu-item">æˆ‘</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">ä¸»é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">æ‚æ–‡</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">æˆ‘</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">ææ‡‚ K8s apiserver aggregation</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-05-31 18:46 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#-how-apiservice-works">ğŸ¤” How APIService Works</a></li>
    <li><a href="#-the-builtin-aggregation-and-handlerchain">ğŸ‘‘ The Builtin Aggregation and HandlerChain</a></li>
    <li><a href="#-how-should-custom-apiserver-do-authn-and-authz-">âœï¸ How should custom apiserver do authn and authz ?</a></li>
    <li><a href="#-further-reading-kube-aggregator-history">ğŸ§— Further Reading: kube-aggregator history</a></li>
    <li><a href="#-summarize">ğŸ“ Summarize</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- ç³»åˆ—é“¾æ¥ -->
<p>æœ¬æ–‡ä¸º <strong>K8s API å’Œæ§åˆ¶å™¨</strong> ç³»åˆ—æ–‡ç« ä¹‹ä¸€</p>
<ul>
<li><a href="../2023-k8s-api-by-crd">K8s CustomResourceDefinitions (CRD) åŸç†</a></li>
<li><a href="../2023-k8s-api-multi-version-conversion-best-practice">K8s å¤šç‰ˆæœ¬ API è½¬æ¢æœ€ä½³å®è·µ</a></li>
<li><a href="../2023-k8s-apiserver-from-scratch">å®ç°ä¸€ä¸ªæç®€ K8s apiserver</a></li>
<li><a href="../2023-k8s-apiserver-aggregation-internals">ææ‡‚ K8s apiserver aggregation</a> (æœ¬æ–‡)</li>
<li><a href="../2023-k8s-api-codegen">æœ€ä¸åŒå…¶çƒ¦çš„ K8s ä»£ç ç”Ÿæˆæ•™ç¨‹</a></li>
<li><a href="../2023-k8s-apiserver-using-library">ä½¿ç”¨ library å®ç° K8s apiserver</a></li>
<li><a href="../2023-k8s-apiserver-avoid-using-runtime">æ…é‡é€‰ç”¨ Runtime ç±»æ¡†æ¶å¼€å‘ K8s apiserver</a></li>
</ul>
<h2 id="-how-apiservice-works">ğŸ¤” How APIService Works</h2>
<p><a href="../2023-k8s-apiserver-from-scratch">å®ç°ä¸€ä¸ªæç®€ K8s apiserver</a> å±•ç¤ºäº†ä½¿ç”¨ APIService å°† custom apiserver èšåˆåˆ° kube-apiserverã€‚èšåˆï¼ˆaggregationï¼‰ç”±æ¨¡å—  kube-aggregator å®ç°ï¼Œå…¶åŸç†å¦‚ä¸‹</p>
<ol start="0">
<li>kube-aggregator watch æ‰€æœ‰ APIService èµ„æºï¼Œæ‰€æœ‰ä¸‰æ–¹ APIService éƒ½ä¼šæŒ‰ç…§ <code>spec.service</code> å­—æ®µè§£ææˆ Service <code>{name}.{namespace}:&lt;port&gt;</code>ã€‚Service ä¸ºèƒŒå apiserver æä¾›è´Ÿè½½å‡è¡¡</li>
<li>å¯åŠ¨ proxyHandlerï¼Œåå‘ä»£ç†ä¸‰æ–¹ apiserver æ‰€æœ‰æµé‡ã€‚CRUD  API å¦‚ <code>/apis/hello.zeng.dev/v1/**</code> å’Œ <code>/apis/metrics.k8s.io/v1beta1/**</code>ï¼Œå…¨éƒ¨äº¤ç»™å¯¹åº” apiserver å¤„ç†</li>
<li>é€šè¿‡ proxyHandlers è®¿é—®æ‰€æœ‰ apiservers è·¯å¾„ /openapi/v2 å’Œ /openapi/v3ï¼Œèšåˆæ‰€æœ‰ OpenAPI Specification ä¿¡æ¯åœ¨ /openapi/v2 å’Œ /openapi/v3</li>
<li>é€šè¿‡ proxyHandlers è®¿é—®æ‰€æœ‰ apiservers æœåŠ¡å‘ç°è·¯å¾„ /apis (1.27+) æˆ–è€… /apis â• /apis/{spec.group}/{spec.version}ï¼Œèšåˆæ‰€æœ‰æœåŠ¡å‘ç°ä¿¡æ¯ï¼Œåœ¨ /apis, /apis/{spec.group} å’Œ /apis/{spec.group}/{spec.version} ç»Ÿä¸€æä¾›æœåŠ¡å‘ç°</li>
</ol>
<img src="/img/2023/custom-apiservice.png" width="800px"/>
<p>âš ï¸âš ï¸âš ï¸ æ³¨æ„ âš ï¸âš ï¸âš ï¸</p>
<ol>
<li>kube-aggregator é€šè¿‡è·¯å¾„ <code>/apis/{spec.group}/{spec.version}</code> å‘èµ·å­˜æ´»æ£€æµ‹ï¼Œå¦‚æœæœªé€šè¿‡ï¼Œè®¿é—®ä¸‰æ–¹ apiserver æ—¶ proxyHandler è¿”å› <code>503 Service Unavailable</code></li>
<li>å¦‚æœä¸‰æ–¹ apiserver åªæä¾› Specification v2ï¼Œkube-aggregator ä¼šè‡ªåŠ¨è½¬æ¢å‡ºä¸€ä»½ v3 ç‰ˆæœ¬</li>
</ol>
<h2 id="-the-builtin-aggregation-and-handlerchain">ğŸ‘‘ The Builtin Aggregation and HandlerChain</h2>
<p><a href="../2023-k8s-api-by-crd">K8s CustomResourceDefinitions (CRD) åŸç†</a> è°ˆåˆ°äº† kube-apiserver å¼•å…¥ CustomResourceDefinitions æ—¶çš„åšæ³•ï¼šé‡‡ç”¨å§”æ‰˜æ¨¡å¼ç»„åˆæ ¸å¿ƒ kube-apiserver æ¨¡å—å’Œ apiextensions-apiserver æ¨¡å—ï¼Œæ”¶åˆ°å®¢æˆ·ç«¯æœåŠ¡è¯·æ±‚æ—¶ï¼Œå…ˆåˆ°æ ¸å¿ƒæ¨¡å—å¯»æ‰¾æ”¯æŒï¼Œå†åˆ°æ‹“å±•æ¨¡å—å¯»æ‰¾æ”¯æŒï¼Œæœ€åå†è¿”å› 404ã€‚</p>
<p>å®é™…ä¸Š kube-apiserver æ¨¡å—åˆä»¥å§”æ‰˜æ¨¡å¼ç»„åˆåœ¨ kube-aggregator æ¨¡å—å†…ã€‚
å®˜æ–¹å†…ç½® API Groups å’Œä¸‰æ–¹ API Groups ä½¿ç”¨äº†åŒä¸€å¥—æ¡†æ¶ï¼Œæ¯ä¸ªå†…ç½® API GroupVersion éƒ½ä¼šåˆ›å»ºé»˜è®¤ APIServiceï¼Œä½†åœ¨ä»£ç†æ¨¡å¼ä¸Šæœ‰æ‰€åŒºåˆ«</p>
<ol>
<li>æ¯ä¸ªå†…ç½® API GroupVersion å¯¹åº” APIService éƒ½ä¼šæ‰“ä¸Š Local æ ‡è¯†ï¼Œè¯¸å¦‚ <code>/api/**</code>, <code>/apis/apps/**</code>, <code>/apis/batch/**</code>, <code>/apis/{crd.group}</code> ç­‰è·¯å¾„ï¼Œç›´æ¥é€šè¿‡æ¨¡å—å§”æ‰˜äº¤ç»™åŒè¿›ç¨‹ kube-apiserver æ¨¡å—å¤„ç†ï¼Œè€Œéèµ°ç½‘ç»œä»£ç†</li>
<li>Discovery API å’Œ OpenAPI Specification ç”± HTTP è¯·æ±‚èšåˆæ”¹ä¸ºäº†ç›´æ¥è¯»å†…å­˜èšåˆ</li>
</ol>
<p>æ¨¡å—åµŒå¥—åŠ ä¸Š <a href="https://github.com/kubernetes/kubernetes/blob/039ae1edf5a71f48ced7c0258e13d769109933a0/staging/src/k8s.io/apiserver/pkg/server/config.go#L890-L960">é€šç”¨ filters/middlewares</a>ï¼Œæ„æˆäº†å®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥å…·ä½“ apiserver å®ç°ä¹‹å‰çš„æµç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">  filterchain
</span></span><span class="line"><span class="cl">+---------------+
</span></span><span class="line"><span class="cl">| panic recover |        +-- hello.zeng.dev-apiserver ---&gt; /apis/hello.zeng.dev/**
</span></span><span class="line"><span class="cl">|   â†“           |        â”‚
</span></span><span class="line"><span class="cl">| tracing       |        |  +--- metrics-apiserver ---&gt; /apis/metmetrics.k8s.io/**
</span></span><span class="line"><span class="cl">|   â†“           |        |  â”‚
</span></span><span class="line"><span class="cl">| log           |        proxy
</span></span><span class="line"><span class="cl">|   â†“           |        â†‘  â†‘
</span></span><span class="line"><span class="cl">| timeout       +---&gt; kube-aggregator ---&gt; /api/**, /apis/**, /openapi/v2, /openapi/v3/**
</span></span><span class="line"><span class="cl">|   â†“           |         â†“            
</span></span><span class="line"><span class="cl">|*authentication|      delegate
</span></span><span class="line"><span class="cl">|   â†“           |         â”‚                       core/legacy group  /api/**
</span></span><span class="line"><span class="cl">| audit         |         â””â”€â”€ kube-apiserver ---&gt; official groups   [/apis/apps/**, /apis/batch/**, ...]
</span></span><span class="line"><span class="cl">|   â†“           |                 â†“
</span></span><span class="line"><span class="cl">| impersonation |              delegate
</span></span><span class="line"><span class="cl">|   â†“           |                 â”‚
</span></span><span class="line"><span class="cl">| flowControl   |                 â””â”€â”€ apiextensions-apiserver ---&gt; CRD groups            /apis/apiextensions.k8s.io/**
</span></span><span class="line"><span class="cl">|   â†“           |                         â†“                        cutsomresource groups /apis/{crd.group}/**
</span></span><span class="line"><span class="cl">|*authorization |                      delegate
</span></span><span class="line"><span class="cl">+---------------+                         â”‚
</span></span><span class="line"><span class="cl">                                          â””â”€â”€ notfoundhandler ---&gt; 404 NotFound
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ custom apiserver æœ€ç›¸å…³çš„ kube-aipserver filters æ˜¯é‰´æƒ authentication(authn) å’Œæˆæƒ authorization(authz)</p>
<ul>
<li>authn æ ¹æ®å®¢æˆ·ç«¯å‡­è¯ï¼Œé‰´åˆ«å‡ºç”¨æˆ·ä¿¡æ¯ <code>(name, uid, groups, extra)</code>ï¼Œæœªé€šè¿‡è¿”å› <code>401 Unauthorized</code></li>
<li>authz æ ¹æ®ç”¨æˆ·ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ <code>(name, groups)</code>ï¼ŒæŸ¥è¯¢ç”¨æˆ·å…·æœ‰ä½•ç§æƒé™ï¼ˆé€šå¸¸æ˜¯ RBACï¼‰ï¼Œæœªé€šè¿‡è¿”å› <code>403 Forbidden</code></li>
</ul>
<p>kube-apiserver è¯¦ç»† authn authz æ¦‚å¿µåœ¨è¿™é‡ŒæŸ¥çœ‹</p>
<ul>
<li><a href="https://github.com/kubernetes/website/blob/2c3355839f6b475cd6a2e8faeb4015324f7d447f/content/en/docs/reference/access-authn-authz/authentication.md">kube-apiserver ç”¨æˆ·æ¦‚å¿µã€authn ç­–ç•¥</a></li>
<li><a href="https://github.com/kubernetes/website/blob/2c3355839f6b475cd6a2e8faeb4015324f7d447f/content/en/docs/reference/access-authn-authz/authorization.md#authorization-modes-authorization-modules">kube-apiserver authz modes</a></li>
</ul>
<h2 id="-how-should-custom-apiserver-do-authn-and-authz-">âœï¸ How should custom apiserver do authn and authz ?</h2>
<p>å®¢æˆ·ç«¯è¯·æ±‚æŠµè¾¾ä¸‰æ–¹ apiserver æœ‰ä¸¤ç§</p>
<ol>
<li>ç» kube-apiserver åå‘ä»£ç†åˆ°è¾¾</li>
<li>å®¢æˆ·ç«¯ç›´æ¥å‘èµ·</li>
</ol>
<p>è¯·æ±‚èƒ½ç» kube-apiserver åå‘ä»£ç†åˆ°è¾¾ custom apiserverï¼Œè¡¨æ˜å®ƒå·²ç»é€šè¿‡ kube-apiserver çš„ authn å’Œ authzã€‚è¢«ä»£ç†çš„ HTTP è¯·æ±‚ä¼šå¸¦æœ‰è¿™äº› Header</p>
<ul>
<li><code>X-Remote-User</code>ï¼Œauthn name</li>
<li><code>X-Remote-Group</code>ï¼Œauthn groups</li>
<li><code>X-Remote-Extra-{key}</code>ï¼Œauthn extra key value</li>
</ul>
<p>åˆ†åˆ«å¯¹åº”ç”¨æˆ·ä¿¡æ¯ <code>(name, groups, extra)</code>ã€‚</p>
<p>âš ï¸âš ï¸âš ï¸ æ³¨æ„ âš ï¸âš ï¸âš ï¸
æ­¤ä¸‰é¡¹ Header åœ¨ kube-apiserver ä¸­ç”±ä¸‰ä¸ªé…ç½®é¡¹æ§åˆ¶ï¼Œé€šå¸¸æŒ‰çº¦å®šå†™æ­»æ— å¿…è¦æ”¹åŠ¨</p>
<ul>
<li><code>--requestheader-username-headers</code>ï¼Œåå®šä¸º <code>X-Remote-User</code></li>
<li><code>--requestheader-group-headers</code>ï¼Œåå®šä¸º <code>X-Remote-Group</code></li>
<li><code>--requestheader-extra-headers-prefix</code>ï¼Œåå®šä¸º <code>X-Remote-Extra-</code></li>
</ul>
<p>custom apiserver é¦–å…ˆåº”è¯¥èƒ½å¤Ÿé‰´åˆ«è¯·æ±‚æ˜¯å¦æ¥è‡ª kube-apiserver ä»£ç†ã€‚</p>
<p>ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œkube-apiserver ä¸­è¿˜æœ‰å‡ é¡¹é…ç½®</p>
<ul>
<li><code>--requestheader-client-ca-file</code>ï¼Œpath to aggregator CA certï¼Œkube-apiserver proxy è¯·æ±‚ TLS è¯ä¹¦ç­¾å‘ CA</li>
<li><code>--requestheader-allowed-names</code>ï¼Œé€šå¸¸æ˜¯ front-proxy-clientï¼Œå¯¹åº” proxy æ¨¡å—è¯ä¹¦é‡Œå¤´çš„ Common Name å­—æ®µ</li>
<li><code>--proxy-client-cert-file</code>ï¼Œpath to aggregator proxy certï¼Œkube-apiserver proxy è¯·æ±‚ TLS è¯ä¹¦</li>
<li><code>--proxy-client-key-file</code>ï¼Œpath to aggregator proxy keyï¼Œkube-apiserver proxy è¯·æ±‚ TLS ç§é’¥</li>
</ul>
<p>kube-apiserver æ‰€éœ€ proxy CA å’Œ proxy è¯ä¹¦ä¼šåœ¨é›†ç¾¤å¯åŠ¨å‰æ—¶ç”± kubeamd ç­‰å·¥å…·ï¼ˆä¹Ÿå¯ä»¥ç”±ç®¡ç†å‘˜æ‰‹å·¥ï¼‰ç”Ÿæˆå¥½ã€‚kube-apiserver ç”Ÿæˆæ—¶ä¼šå¾€ kube-system namespace å†™å…¥ ConfigMap/extension-apiserver-authenticationã€‚</p>
<p>è¿è¡Œåœ¨ K8s ä¸­çš„ custom apiserver é¦–å…ˆåº”è¯¥ç»‘å®š Kubernetes å†…ç½®çš„å¦‚ä¸‹æƒé™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extension-apiserver-authentication-reader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">extension-apiserver-authentication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">configmaps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>custom apiserver å¤„ç†è¯·æ±‚æ—¶</p>
<ul>
<li>é¦–å…ˆåº”è¿›è¡Œå®¢æˆ·ç«¯ TLS è¯ä¹¦éªŒè¯ï¼šå…ˆçœ‹æ˜¯å¦ç”± client-ca-file ç­¾å‘ï¼Œå†éªŒè¯ TLS è¯ä¹¦ Common Name æ˜¯å¦ä¸º allowed-names ä¹‹ä¸€ã€‚éªŒè¯é€šè¿‡è¡¨æ˜æµé‡æ¥è‡ª kube-apiserverï¼Œè‡ª <code>(X-Remote-User, X-Remote-Group, X-Remote-Extra-*)</code> æå–å‡º authn ä¿¡æ¯ã€‚å¦åˆ™</li>
<li>è¯·æ±‚éå¯ä¿¡ï¼Œåº”å½“å¯¹å…¶æ‰§è¡Œ authn</li>
</ul>
<p>è€Œä¸€èˆ¬åœ°ï¼Œæ‰€æœ‰ç”¨æˆ·ã€æƒé™ä¿¡æ¯åˆåªä¿å­˜åœ¨ kube-apiserverã€‚kube-apiserver æä¾›äº†ä¸€ä¸ªä¸“ä¾› authn çš„ HTTP POST æ¥å£ <code>/apis/authentication.k8s.io/v1/tokenreviews</code> è§£å†³æ­¤ç±» authn é—®é¢˜</p>
<p>å‡è®¾ token æ¥è‡ª namespace hello ä¸‹çš„ service account meï¼Œauthn è¿‡ç¨‹å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -v -XPOST  -H &#34;Accept: application/json&#34; -H &#34;Content-Type: application/json&#34; \
</span></span><span class="line"><span class="cl">https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews -d &#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;apiVersion&#34;: &#34;authentication.k8s.io/v1&#34;,
</span></span><span class="line"><span class="cl">  &#34;kind&#34;: &#34;TokenReview&#34;,
</span></span><span class="line"><span class="cl">  &#34;spec&#34;: {
</span></span><span class="line"><span class="cl">    &#34;token&#34;: &#34;014fbff9a07c...&#34;
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>kube-apiserver authn è¯¥ tokenï¼Œé€šè¿‡åè¿”å›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;apiVersion&#34;: &#34;authentication.k8s.io/v1&#34;,
</span></span><span class="line"><span class="cl">  &#34;kind&#34;: &#34;TokenReview&#34;,
</span></span><span class="line"><span class="cl">  &#34;spec&#34;: {
</span></span><span class="line"><span class="cl">    &#34;token&#34;: &#34;014fbff9a07c...&#34;
</span></span><span class="line"><span class="cl">  },
</span></span><span class="line"><span class="cl">  &#34;status&#34;: {
</span></span><span class="line"><span class="cl">    &#34;username&#34;: &#34;system:serviceaccount:hello:me&#34;,
</span></span><span class="line"><span class="cl">    &#34;uid&#34;: &#34;685c1d52-ab61-49be-9228-a3fa1e839a77&#34;, 
</span></span><span class="line"><span class="cl">    &#34;groups&#34;: [ &#34;system:serviceaccounts&#34;, &#34;system:serviceaccounts:hello&#34;, &#34;system:authenticated&#34;] 
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>authn å–å¾—ç”¨æˆ·ä¿¡æ¯ä¹‹åï¼Œè¿˜éœ€è¦è¿›è¡Œ authzï¼Œæ‰çœŸæ­£åˆ°è¾¾ä¸šåŠ¡å¤„ç†ã€‚é’ˆå¯¹è¿™ç±» authz ï¼Œkube-apiserver æ¥å£æ˜¯ <code>POST /apis/authorization.k8s.io/v1/subjectaccessreviews</code></p>
<p>å‡è®¾ custom apiserver éœ€è¦ authz serviceaccount hello/me æ˜¯å¦èƒ½å¤Ÿ list /apis/hello.zeng.dev/namespaces/default/foosï¼Œäº¤äº’åè®®å¦‚ä¸‹ï¼ˆæœåŠ¡ç«¯ç”¨ JSON ä¼ è¾“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -v -XPOST  -H <span class="s2">&#34;Accept: application/yaml&#34;</span> -H <span class="s2">&#34;Content-Type: application/yaml&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s1">&#39;https://10.96.0.1:443/apis/authorization.k8s.io/v1/subjectaccessreviews?timeout=10s&#39;</span> -d <span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">kind: SubjectAccessReview
</span></span></span><span class="line"><span class="cl"><span class="s1">apiVersion: authorization.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s1">metadata: {}
</span></span></span><span class="line"><span class="cl"><span class="s1">spec:
</span></span></span><span class="line"><span class="cl"><span class="s1">  resourceAttributes:
</span></span></span><span class="line"><span class="cl"><span class="s1">    namespace: default
</span></span></span><span class="line"><span class="cl"><span class="s1">    verb: list
</span></span></span><span class="line"><span class="cl"><span class="s1">    group: hello.zeng.dev
</span></span></span><span class="line"><span class="cl"><span class="s1">    version: v1
</span></span></span><span class="line"><span class="cl"><span class="s1">    resource: foos
</span></span></span><span class="line"><span class="cl"><span class="s1">  user: system:serviceaccount:hello:me
</span></span></span><span class="line"><span class="cl"><span class="s1">  groups:
</span></span></span><span class="line"><span class="cl"><span class="s1">  - system:serviceaccounts
</span></span></span><span class="line"><span class="cl"><span class="s1">  - system:serviceaccounts:hello
</span></span></span><span class="line"><span class="cl"><span class="s1">  - system:authenticated
</span></span></span><span class="line"><span class="cl"><span class="s1">  uid: 7c34f861-56c5-491d-a69c-6826fcd8578d
</span></span></span><span class="line"><span class="cl"><span class="s1">status:
</span></span></span><span class="line"><span class="cl"><span class="s1">  allowed: false&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>kube-apiserver å“åº”ä¼šæ›´æ–° status å­—æ®µï¼Œå¦‚æœ <code>.status.allow</code> ä¸º true è¡¨æ˜ authz æˆåŠŸ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SubjectAccessReview</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span>{<span class="l">...}</span><span class="w"> </span><span class="c"># spec ä¸é€å…¥ä¿æŒä¸€è‡´</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">allowed</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥ custom apiserver é€šå¸¸è¿˜ä¼šç»‘å®šå¦‚ä¸‹ Kubernetes å†…ç½®æƒé™ï¼Œæ‰èƒ½å°† authn å’Œ authz å§”æ‰˜ç»™ kube-apiserser</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:auth-delegator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">authentication.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">tokenreviews</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">create</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">subjectaccessreviews</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">create</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æµç¨‹å›¾: request â†”ï¸ kube-apiserver â†”ï¸ custom-apiserver</p>
<style> .mermaid svg { width: 72%;} </style>
<div class="mermaid">sequenceDiagram
%%{init: { 'sequence': {
'noteAlign': 'left', 'messageAlign': 'center'
}}}%%

actor kubectl/AnyClient
kubectl/AnyClient -) kube-apiserver: delete foo/test
kube-apiserver ->> kube-apiserver: authn/authz OK
kube-apiserver ->>+ hello-apiserver: Proxy Request with <br/>X-Remote-User<br/>X-Remote-Group<br/>X-Remote-Extra-
hello-apiserver ->> hello-apiserver: TLS Cert verify OK
Note right of hello-apiserver: userinfo<br/>{name: X-Remote-User<br/>groups: X-Remote-Group<br/>extraX-Remote-Extra-}
hello-apiserver ->>+ kube-apiserver: delegate authz <br/> POST SubjectAccessReview
kube-apiserver ->>- hello-apiserver: 200 OK with<br/>SubjectAccessReview<br/>status.allow=true
hello-apiserver ->> hello-apiserver: execute delete
hello-apiserver ->>- kube-apiserver: 200 OK
kube-apiserver -) kubectl/AnyClient: 200 OK 
</div>
<p>æµç¨‹å›¾: request â†”ï¸ custom-apiserver</p>
<div class="mermaid">sequenceDiagram 

actor kubectl/AnyClient

kubectl/AnyClient ->> hello-apiserver: delete foo/test
hello-apiserver -->> hello-apiserver: TLS Cert <br/> verify failed
hello-apiserver ->>+ kube-apiserver: delegate authn <br/> POST TokenReview
kube-apiserver ->> kube-apiserver: authn OK
kube-apiserver ->>- hello-apiserver: 200 OK with<br/> userInfo in TokenReview status
hello-apiserver ->>+ kube-apiserver: delegate authz <br/> POST SubjectAccessReview
kube-apiserver ->> kube-apiserver: authz OK
kube-apiserver ->>- hello-apiserver: 200 OK with SubjectAccessReview<br/>status.allow=true
hello-apiserver ->> hello-apiserver: execute delete
hello-apiserver ->> kubectl/AnyClient: 200 OK
</div>
<!-- <img src="/img/2023/custom-apiserver-delegate-authn-authz.png" width="700px" height="700px"/> -->
<p>ğŸª¬ğŸª¬ğŸª¬ ç›®å‰ X-Remote-* headers æ²¡æœ‰æºå¸¦ authz ä¿¡æ¯ã€‚æ— è®º kube-apiserver æ˜¯å¦å…ˆæ‰§è¡Œäº† authzï¼Œcustom apiserver éƒ½è¦ authn ä¹‹åè¦è¿›è¡Œæ‰§è¡Œ authzã€‚</p>
<p>ğŸª¬ğŸª¬ğŸª¬ custom apiserver å½“ç„¶å¯ä»¥è‡ªè¡Œè¯»å– kube-apiserver å­˜å‚¨ï¼Œè‡ªè¡Œåœ¨æœ¬åœ°å®ç° authn, authzï¼Œä½†æ˜¯ä¸æ¨èã€‚</p>
<p>ğŸª¬ğŸª¬ğŸª¬ ç”±äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦è¿œç¨‹ authzï¼Œcustom apiserver å¯ä»¥ç¼“å­˜ authz ç»“æœã€‚</p>
<h2 id="-further-reading-kube-aggregator-history">ğŸ§— Further Reading: kube-aggregator history</h2>
<p>æŸ¥çœ‹ <a href="https://github.com/kubernetes/design-proposals-archive/blob/acc25e14ca83dfda4f66d8cb1f1b491f26e78ffe/api-machinery/aggregated-api-servers.md">proposal: Aggregated API Servers</a>ï¼Œå¯ä»¥å‘ç°ç¤¾åŒºå½“æ—¶é¢ä¸´çš„é—®é¢˜</p>
<ol>
<li>è‡ªèº«ä¸šåŠ¡æœ‰æ‹†å•ä½“ kube-apiserver ä¸ºå¤šä¸ª aggregated servers çš„éœ€æ±‚</li>
<li>ç”¨æˆ·/ä¸‰æ–¹æœºæ„æœ‰è‡ªå·±å®ç° custom apiserver å¹¶æš´éœ² custom API çš„éœ€æ±‚</li>
</ol>
<p>ç¤¾åŒºè§£å†³æ–¹æ¡ˆç»å†äº†è®¸å¤šä¸ª PR è¿­ä»£ï¼Œä¸»è¦ç”± <a href="https://github.com/kubernetes/kubernetes/pulls?page=29&amp;q=is%3Apr+is%3Aclosed+author%3Adeads2k">deads2k è´¡çŒ®</a>ï¼Œåœ¨ Kubernetes è¿›å…¥ v1.7.0 Beta (é»˜è®¤å¼€å¯)ï¼Œv1.10 è¿›å…¥ GA</p>
<p>2016 å¹´ 5 æœˆ <a href="https://github.com/kubernetes/kubernetes/pull/20358">kubernetes PR20358</a> ä¸ºç¬¬ä¸€æ¬¡æäº¤ï¼Œå¢åŠ äº†ä¸€ä¸ªåä¸ºç¬¬ç‹¬ç«‹è¿›ç¨‹ kube-discoveryã€‚å®ƒçš„åŠŸèƒ½éå¸¸åŸå§‹ï¼Œä»…æä¾› API disovery ä¿¡æ¯èšåˆï¼Œå…·ä½“æ¥è¯´å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶æä¾›çš„ apiservers åˆ—è¡¨ï¼Œé€ä¸ªè®¿é—®ï¼Œå°† kube-apiserver æ ¸å¿ƒ API Group ä¿¡æ¯èšåˆåˆ° /apiï¼Œå°†å…¶ä»– API Groupsï¼ˆå®˜æ–¹ã€ä¸‰æ–¹ï¼‰ä¸€èµ·ç»„åˆåˆ° /apisã€‚</p>
<p>2016 å¹´ 12 æœˆç»å†äº†å¤šä¸ªè¿­ä»£</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/pull/37561">kubernetes PR37561</a> å¼•å…¥æœåŠ¡å‘ç° GroupVersionKind <code>apiregistration.k8s.io/v1alpha1 APIService</code></li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/38319">kubernetes PR38319</a> kube-discovery /api å’Œ /apis å¼€å§‹é€šè¿‡ APIService èšåˆå®˜æ–¹ API</li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/38624">kubernetes PR38289</a> æä¾›äº† proxyHandler</li>
</ul>
<p>2017 å¹´ 3 æœˆåˆå¹¶æäº¤å¥ å®šäº† kube-aggregator å½¢æ€ï¼Œä¸€ç›´æ²¿ç”¨è‡³ä»Š (v1.27)</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/pull/39619">kubernetes 39619</a> kube-discovery æ”¹åä¸º kube-apiserver</li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/42911">kubernetes PR42911</a> åˆå¹¶äº† kube-apiserver æ¨¡å—å’Œ kube-aggregator æ¨¡å—</li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/46055">kubernetes PR46055</a> å¹¶å…¥äº† CRD æ¨¡å— apiextensions-apiserverï¼Œå§”æ‰˜é“¾ä¸º kube-aggregator â¡ï¸ (apiextensions-apiserver â¡ï¸ kube-apiserver)</li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/46440">kubernetes PR46440</a> è°ƒæ•´å§”æ‰˜é“¾ä¸º kube-aggregator â¡ï¸ (kube-apiserver â¡ï¸ apiextensions-apiserver)</li>
</ul>
<p>ğŸ‘ğŸ‘ğŸ‘ æ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡å‡ºå…¶ä»–é‡è¦ PR</p>
<h2 id="-summarize">ğŸ“ Summarize</h2>
<p>æœ¬æ–‡å›´ç»•æ ¸å¿ƒåè®® APIServiceï¼Œæ¢³ç†äº† Kubernetes apiserver aggregation åŸç†ã€‚è¯»è€…ç†è§£äº† APIService èƒŒåçš„è¿ä½œåŸç†ï¼Œå°±ææ‡‚äº† apiserver aggregation é­”æ³•å¦‚ä½•å¯èƒ½ã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/">Configure the Aggregation Layer</a> ä¸€ç›´å¾ˆä»¤äººè´¹è§£ï¼Œåªåˆ—äº†åˆ—å¹²å·´å·´çš„æ¥å…¥æµç¨‹ã€‚å…¶å®åªè¦å…ˆäº†è§£ kube-apiserver handlerChainï¼ŒåŒºåˆ†å¥½è¯·æ±‚æ¥æºï¼Œå°±å¤§ä½“æ˜ç™½ custom apiserver åº”è¯¥å¦‚ä½•å¤„ç† authn å’Œ authzã€‚</p>
<p>æœ€åï¼Œæœ¬æ–‡æ¢³ç†äº† kube-aggregator é‡è¦ Pull Requestï¼Œä¾›æœ‰å…´è¶£è¯»è€…è¿›ä¸€æ­¥æŸ¥é˜…ã€‚</p>
<!-- API Aggregation timeline -->
<!-- 1st federated api servers, named kube-discovery -->
<!-- v1.6.0-alpha.1: api federation types apiregistration.k8s.io/v1alpha1 apiservices -->
<!-- add summarizing discovery controller and handlers -->
<!-- kubernetes-discovery proxy -->
<!-- rename kubernetes-discovery to kube-aggregator -->
<!-- v1.7.0-alpha.1: kubernetes PR42911 combine kube-apiserver and kube-aggregator -->

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Zeng Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-05-31 18:46
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">æœ¬ä½œå“é‡‡ç”¨ <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®®</a> è¿›è¡Œè®¸å¯ï¼Œè½¬è½½æ—¶è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ã€‚</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2023-k8s-api-codegen/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">æœ€ä¸åŒå…¶çƒ¦çš„ K8s ä»£ç ç”Ÿæˆæ•™ç¨‹</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2023-k8s-apiserver-from-scratch/">
            <span class="next-text nav-default">å®ç°ä¸€ä¸ªæç®€ K8s apiserver</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2023-05-31 18:46:31 \u002b0800 CST',
        title: 'ææ‡‚ K8s apiserver aggregation',
        clientID: '6ab3c721bb197ea92f1e',
        clientSecret: '217d38cc1905f60f1d963c555be606ed3e707937',
        repo: 'phosae.github.io',
        owner: 'phosae',
        admin: ['phosae'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zenngxu@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/phosae" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/u/1566013967" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://www.zeng.dev/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zeng Xu</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-FEPN2KZF84"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-FEPN2KZF84', { 'anonymize_ip': false });
}
</script>






<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>





</body>
</html>
