<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>v1.14.5 - v1.21.14 Kubernetes è·¨ç‰ˆæœ¬å‡çº§è®°å½• - ZengXu&#39;s BLOG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zeng Xu" /><meta name="description" content="Upgrade Kubernetes from v1.14.5 to v1.21.14" /><meta name="keywords" content="kubernetes" />






<meta name="generator" content="Hugo 0.125.0 with theme even" />


<link rel="canonical" href="https://www.zeng.dev/post/2023-kubernetes-upgrade-1.14-1.21/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.3ab191e0444a0833d62fa8f1e44231fc793f2c04a2474a8b9348894c550f8388.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://www.zeng.dev/post/2023-kubernetes-upgrade-1.14-1.21/">
  <meta property="og:site_name" content="ZengXu&#39;s BLOG">
  <meta property="og:title" content="v1.14.5 - v1.21.14 Kubernetes è·¨ç‰ˆæœ¬å‡çº§è®°å½•">
  <meta property="og:description" content="Upgrade Kubernetes from v1.14.5 to v1.21.14">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
  <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-11-30T16:58:24+08:00">
    <meta property="article:modified_time" content="2024-05-24T16:38:00+08:00">
    <meta property="article:tag" content="Kubernetes">

  <meta itemprop="name" content="v1.14.5 - v1.21.14 Kubernetes è·¨ç‰ˆæœ¬å‡çº§è®°å½•">
  <meta itemprop="description" content="Upgrade Kubernetes from v1.14.5 to v1.21.14">
  <meta itemprop="datePublished" content="2023-11-30T16:58:24+08:00">
  <meta itemprop="dateModified" content="2024-05-24T16:38:00+08:00">
  <meta itemprop="wordCount" content="3555">
  <meta itemprop="keywords" content="kubernetes"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="v1.14.5 - v1.21.14 Kubernetes è·¨ç‰ˆæœ¬å‡çº§è®°å½•">
<meta name="twitter:description" content="Upgrade Kubernetes from v1.14.5 to v1.21.14">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">ä¸»é¡µ</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">
        <li class="mobile-menu-item">æ‚æ–‡</li>
      </a><a href="/about">
        <li class="mobile-menu-item">æˆ‘</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">ä¸»é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">æ‚æ–‡</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">æˆ‘</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">v1.14.5 - v1.21.14 Kubernetes è·¨ç‰ˆæœ¬å‡çº§è®°å½•</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-11-30 16:58 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#èƒŒæ™¯å’Œå‡çº§ç­–ç•¥">èƒŒæ™¯å’Œå‡çº§ç­–ç•¥</a></li>
    <li><a href="#cluster-çº§å‡çº§åœ¨é¦–ä¸ª-master-èŠ‚ç‚¹æ‰§è¡Œ">cluster çº§å‡çº§ï¼ˆåœ¨é¦–ä¸ª master èŠ‚ç‚¹æ‰§è¡Œ</a></li>
    <li><a href="#å…¶ä»–-master-èŠ‚ç‚¹æ›´æ–°">å…¶ä»– master èŠ‚ç‚¹æ›´æ–°</a></li>
    <li><a href="#114--115-è¸©å‘è®°å½•">1.14 â†’ 1.15 è¸©å‘è®°å½•</a></li>
    <li><a href="#115---116-è¸©å‘è®°å½•">1.15 -&gt; 1.16 è¸©å‘è®°å½•</a></li>
    <li><a href="#118---119-è¸©å‘è®°å½•">1.18 -&gt; 1.19 è¸©å‘è®°å½•</a></li>
    <li><a href="#119---120-æ³¨æ„ç‚¹">1.19 -&gt; 1.20 æ³¨æ„ç‚¹</a></li>
    <li><a href="#120---121-æ³¨æ„ç‚¹">1.20 -&gt; 1.21 æ³¨æ„ç‚¹</a></li>
    <li><a href="#ç³»ç»Ÿçº§é•œåƒå‘ç‚¹">ç³»ç»Ÿçº§é•œåƒå‘ç‚¹</a></li>
    <li><a href="#ä»»æ„-worker-èŠ‚ç‚¹æ›´æ–°">ä»»æ„ worker èŠ‚ç‚¹æ›´æ–°</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
    <li><a href="#å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="èƒŒæ™¯å’Œå‡çº§ç­–ç•¥">èƒŒæ™¯å’Œå‡çº§ç­–ç•¥</h2>
<p>å‡çº§é›†ç¾¤ï¼Œé¦–å…ˆå…³æ³¨å“ªäº› API åœ¨æ–°ç‰ˆæœ¬è¢«åºŸå¼ƒ (ç§»é™¤) äº†ã€‚è¿™ä¸€ç‚¹å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide">Deprecated API Migration Guide</a>ã€‚
å°½ç®¡ K8s æœ€æ–°ç‰ˆæœ¬å·²ç»æ˜¯ v1.28.4ï¼Œä½†æˆ‘ä»¬çº¿ä¸Š K8s ç‰ˆæœ¬ä»æ—§ä¸º v1.14.5ã€‚ç”±äºä¸šåŠ¡ä¾èµ–çš„ä¸å°‘ API åœ¨ 1.22 ä¹‹åè¢«ç§»é™¤ï¼Œå¦‚</p>
<ul>
<li>admissionregistration.k8s.io/v1beta1 MutatingWebhookConfiguration and ValidatingWebhookConfiguration</li>
<li>apiextensions.k8s.io/v1beta1 CustomResourceDefinition</li>
<li>coordination.k8s.io/v1beta1 Lease</li>
<li>extensions/v1beta1 Ingress, networking.k8s.io/v1beta1 Ingress</li>
<li>networking.k8s.io/v1beta1 IngressClass</li>
</ul>
<p>è¿™ä¾¿å†³å®šäº†æ— æ³•ä¸€æ­¥åˆ°ä½å‡åˆ° v1.28.xï¼Œè€Œåªèƒ½é‡‡ç”¨å…ˆå‡çº§åˆ° v1.21.x å†é€æ­¥å¾€ä¸Šå‡çº§çš„æ–¹å¼ã€‚æœ¬æ–‡è®°å½• v1.14.5 åˆ° v1.21.14 çš„æ“ä½œæ­¥éª¤å’Œé—®é¢˜è§£å†³æ–¹å¼ã€‚</p>
<p>é›†ç¾¤å‡çº§æ–¹å¼ä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œå…¶ä¸€æ˜¯å¦å»ºç›®æ ‡é›†ç¾¤å¹¶é€æ­¥è¿ç§»å®Œæ‰€æœ‰æœåŠ¡ï¼Œå…¶äºŒæ˜¯é€èŠ‚ç‚¹åŸåœ°å‡çº§ã€‚
å¦‚æœé€‰æ‹©å¦å»º v1.21.x å¹¶æ‰§è¡Œè¿ç§»çš„æ–¹å¼ï¼Œå…ˆè¦åœ¨å¤–å±‚ç½‘å…³å±‚å®ç°é›†ç¾¤åˆ‡æµåŠŸèƒ½ï¼Œå†è¦æå‰åœ¨æ–°é›†ç¾¤éƒ¨ç½²å¥½æ‰€æœ‰æœåŠ¡ï¼Œæœ€ç»ˆé€æ­¥å®Œæˆåˆ‡æµã€‚
è€ƒè™‘åˆ°æˆ‘ä»¬æ²¡æœ‰ä¸»ä»é›†ç¾¤åˆ‡æµå±‚ã€æœºå™¨èµ„æºç›¸å¯¹æœ‰é™ã€åŠ ä¹‹é›†ç¾¤æœ‰çŠ¶æ€æœåŠ¡æ²¡æ³•ç®€å•æŒªç§»ï¼Œå› æ­¤é€‰æ‹©äº†åŸåœ°å‡çº§ã€‚</p>
<p>kubeadm åœ¨ v1.29 ä¹‹å‰ä»…æ”¯æŒé€ minor ç‰ˆæœ¬å‡çº§é›†ç¾¤ï¼Œå³åªèƒ½ v1.14 -&gt; v1.15 -&gt; v1.16 -&gt; v1.17 -&gt; v1.18 -&gt; v1.19 -&gt; v1.20 -&gt; v1.21ã€‚è¯¦ç»†å¯å‚è€ƒ <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">Upgrading kubeadm clusters</a>ã€‚ï¼ˆkubeadm v1.29 ä¹‹åå°†æ”¯æŒè·¨ 3 ä¸ª minor ç‰ˆæœ¬å‡çº§ï¼Œå³å¯ä»¥ v1.26 -&gt; v1.29 -&gt; v1.32ï¼Œè¯¦ç»†å¯å‚è€ƒ <a href="https://github.com/kubernetes/kubeadm/issues/2924">kubeadm#2924 - adjust the kubeadm/kubelet skew policy</a> ğŸš€</p>
<p>åˆï¼Œä» v1.14 è‡³ v1.21ï¼Œkubelet ä¸ apiserver ä¹‹é—´çš„é€šä¿¡ API æ²¡æœ‰å‘ç”Ÿç§»é™¤ï¼Œv1.14 kubelet å¯ä¸ v1.14.5 åˆ° v1.21.14 ä¹‹é—´çš„ä»»ä½•ç‰ˆæœ¬çš„ apiserver é€šä¿¡ã€‚
å› æ­¤å‡çº§ç­–ç•¥ä¸º</p>
<ol>
<li>é€æ­¥å‡çº§ control plane è‡³ v1.21</li>
<li>ä¸€æ­¥åˆ°ä½å‡çº§ worker node v1.14 è‡³ v1.21</li>
</ol>
<img src="/img/2023/k8s-upgrade-flow.png" width="600px"/>
<p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå³ä½¿å‡çº§ kubelet æ—¶ Pod Containers æœ‰è¢«é‡å¯çš„é£é™©ã€‚è¿™äº‹ä¹Ÿåªä¼šå‘ç”Ÿä¸€æ¬¡ã€‚æ³¨æ„</p>
<ul>
<li>å‡çº§ kubelet å¯èƒ½å¯¼è‡´ Pod Containers è¢«é‡å¯ï¼Œè§ <a href="https://github.com/kubernetes/kubernetes/issues/63814">kubernetes#63814 - kubelet&rsquo;s calculation of whether a container has changed can cause cluster-wide outages</a></li>
<li>ç”šè‡³å‡çº§ containerd ä¹Ÿå¯èƒ½å¯¼è‡´é‡å¯ <a href="https://github.com/containerd/containerd/pull/7845">containerd#7845 - CRI: Fix no CNI info for pod sandbox on restart</a></li>
</ul>
<p>é€šå¸¸æ¥è¯´ï¼Œå¥å£®çš„æœåŠ¡ç¾¤åº”èƒ½å®¹å¿å¶å‘é‡å¯æˆ–è€…é‡æ–°è°ƒåº¦ã€‚</p>
<h2 id="cluster-çº§å‡çº§åœ¨é¦–ä¸ª-master-èŠ‚ç‚¹æ‰§è¡Œ">cluster çº§å‡çº§ï¼ˆåœ¨é¦–ä¸ª master èŠ‚ç‚¹æ‰§è¡Œ</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="c1"># download kubeadm, kubelet, kubectl binary</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> VERSION in v1.15.12 v1.16.15 v1.17.17 v1.18.20 v1.19.16 v1.20.15 v1.21.14<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  wget -O /etc/kubernetes/upgrade/kubeadm-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubeadm
</span></span><span class="line"><span class="cl">  chmod +x /etc/kubernetes/upgrade/kubeadm-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  wget -O /etc/kubernetes/upgrade/kubelet-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubelet
</span></span><span class="line"><span class="cl">  chmod +x /etc/kubernetes/upgrade/kubelet-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  wget -O kubectl-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubectl
</span></span><span class="line"><span class="cl">  chmod +x /etc/kubernetes/upgrade/kubectl-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># start copying container images to the private registry:  </span>
</span></span><span class="line"><span class="cl"><span class="c1">#   kube-apiserver, kube-controller-manager, kube-scheduler, kube-proxy, coredns, pause</span>
</span></span><span class="line"><span class="cl"><span class="c1"># if your company has no private registry, you can skip this step</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> VERSION in v1.15.12 v1.16.15 v1.17.17 v1.18.20 v1.19.16 v1.20.15 v1.21.14<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  skopeo copy --multi-arch all docker://registry.aliyuncs.com/google_containers/kube-apiserver:<span class="nv">$VERSION</span> docker://myregisty/google-containers/kube-apiserver:<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  skopeo copy --multi-arch all docker://registry.aliyuncs.com/google_containers/kube-controller-manager:<span class="nv">$VERSION</span> docker://myregisty/google-containers/kube-controller-manager:<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  skopeo copy --multi-arch all docker://registry.aliyuncs.com/google_containers/kube-scheduler:<span class="nv">$VERSION</span> docker://myregisty/google-containers/kube-scheduler:<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  skopeo copy --multi-arch all docker://registry.aliyuncs.com/google_containers/kube-proxy:<span class="nv">$VERSION</span> docker://myregisty/google-containers/kube-proxy:<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> VERSION in 1.6.2 1.6.5 1.6.7 1.7.0 v1.8.0<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  skopeo copy --multi-arch all docker://registry.aliyuncs.com/google_containers/coredns:<span class="nv">$VERSION</span> docker://myregistry/google-containers/coredns:<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> VERSION in 3.2 3.4.1<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  skopeo copy --multi-arch all docker://registry.aliyuncs.com/google_containers/pause:<span class="nv">$VERSION</span> docker://myregistry/google-containers/pause:<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># end copying container images</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ <code>kubeadm upgrade apply &lt;targetVersion&gt;</code> æ‰§è¡Œé¦–ä¸ª control plane å‡çº§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.14.5ï¼Œwoker nodes ä¸º v1.14.5ï¼Œæ­£å¸¸ä½¿ç”¨ kubeadm upgrade apply å³å¯</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.15.12 upgrade apply v1.15.12
</span></span><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.15.12ï¼Œwoker nodes ä¸º v1.14.5ï¼Œå¿…é¡»æ­é… -f å‚æ•°å¼ºåˆ¶å‡çº§</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.16.15 upgrade apply v1.16.15 -f
</span></span><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.16.15ï¼Œwoker nodes ä¸º v1.14.5ï¼Œå¿…é¡»æ­é… -f å‚æ•°å¼ºåˆ¶å‡çº§</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.17.17 upgrade apply v1.17.17 -f 
</span></span><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.17.17ï¼Œwoker nodes ä¸º v1.14.5ï¼Œå¿…é¡»æ­é… -f å‚æ•°å¼ºåˆ¶å‡çº§</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.18.20 upgrade apply v1.18.20 -f
</span></span><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.18.20ï¼Œwoker nodes ä¸º v1.14.5ï¼Œå¿…é¡»æ­é… -f å‚æ•°å¼ºåˆ¶å‡çº§</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.19.16 upgrade apply v1.19.16 -f
</span></span><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.19.16ï¼Œwoker nodes ä¸º v1.14.5ï¼Œå¿…é¡»æ­é… -f å‚æ•°å¼ºåˆ¶å‡çº§</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.20.15 upgrade apply v1.20.15 -f
</span></span><span class="line"><span class="cl"><span class="c1"># control plane ä¸º v1.20.15ï¼Œwoker nodes ä¸º v1.14.5ï¼Œå¿…é¡»æ­é… -f å‚æ•°å¼ºåˆ¶å‡çº§</span>
</span></span><span class="line"><span class="cl">/etc/kubernetes/upgrade/kubeadm-v1.21.14 upgrade apply v1.21.14 -f
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯æ¬¡æ‰§è¡Œä¹‹åï¼Œå¤§è‡´å‘ç”Ÿä»¥ä¸‹äº‹æƒ…</p>
<ul>
<li>apply kube-system ä¸­çš„é›†ç¾¤é…ç½®ï¼Œå¦‚ kubeadm-config (i.e ClusterConfiguration)ï¼Œkubelet-config-$VERSIONï¼ŒCoreDNS ä»¥åŠ kube-proxy ConfigMap</li>
<li>æ›´æ–°é¦–ä¸ª master èŠ‚ç‚¹ä¸Šçš„ kube-apiserver, kube-controller-manager, kube-schedulerï¼ˆå³ /etc/kubernetes/manifests ç›®å½•çš„ static Pod manifests</li>
<li>æ›´æ–°é›†ç¾¤ä¸­çš„ CoreDNS å’Œ kube-proxy</li>
</ul>
<p>æ‰€ä»¥æ¯æ¬¡æ›´æ–°å®Œé›†ç¾¤ä¹‹åï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
<ul>
<li>é¦–ä¸ª master èŠ‚ç‚¹ä¸Šçš„ kube-apiserver, kube-controller-manager, kube-scheduler</li>
<li>CoreDNS</li>
<li>kube-proxy</li>
<li>CNI Plugin</li>
</ul>
<h2 id="å…¶ä»–-master-èŠ‚ç‚¹æ›´æ–°">å…¶ä»– master èŠ‚ç‚¹æ›´æ–°</h2>
<p>ä¸‹è½½ç¨‹åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> VERSION in v1.15.12 v1.16.15 v1.17.17 v1.18.20 v1.19.16 v1.20.15 v1.21.14<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  wget -O /etc/kubernetes/upgrade/kubeadm-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubeadm
</span></span><span class="line"><span class="cl">  chmod +x /etc/kubernetes/upgrade/kubeadm-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  wget -O /etc/kubernetes/upgrade/kubelet-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubelet
</span></span><span class="line"><span class="cl">  chmod +x /etc/kubernetes/upgrade/kubelet-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">  wget -O kubectl-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubectl
</span></span><span class="line"><span class="cl">  chmod +x /etc/kubernetes/upgrade/kubectl-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œ <code>kubeadm upgrade node</code> å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span> 
</span></span><span class="line"><span class="cl"><span class="nv">VERSION</span><span class="o">=</span>v1.15.12 <span class="c1"># v1.16.15 ... v1.21.14 ç­‰å…¶ä»–ç‰ˆæœ¬å¯¹å·å…¥åº§</span>
</span></span><span class="line"><span class="cl">./kubeadm-<span class="nv">$VERSION</span> upgrade node --certificate-renewal<span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl">mv kubelet-<span class="nv">$VERSION</span> /usr/local/bin/kubelet
</span></span><span class="line"><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="cl">sudo systemctl restart kubelet
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äº control plane æ‰€åœ¨èŠ‚ç‚¹ï¼Œæ‰§è¡Œ <code>kubeadm upgrade node</code> ä¼š</p>
<ul>
<li>è·å– kubeadm <code>ClusterConfiguration</code>ï¼Œæ›´æ–° kube-apiserver, kube-controller-manager, kube-scheduler ï¼ˆå³ static Pod manifests</li>
<li>æ›´æ–° kubelet å¯åŠ¨é…ç½®</li>
</ul>
<p>å› æ­¤ä¹‹ååªè¦æ›´æ¢ kubelet äºŒè¿›åˆ¶ï¼Œé‡å¯ kubelet å³å¯å®Œæˆ control plane èŠ‚ç‚¹æ›´æ–°ã€‚</p>
<h2 id="114--115-è¸©å‘è®°å½•">1.14 â†’ 1.15 è¸©å‘è®°å½•</h2>
<ul>
<li>
<p>kubelet æ— æ³•å¯åŠ¨ï¼ŒåŸå› æ˜¯ <a href="https://github.com/kubernetes/kubernetes/pull/77820">kubernetes#77820 - Remove deprecated Kubelet security controls</a> ç§»é™¤äº†è¯¥å‚æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Nov 28 18:05:27 master-1 kubelet[884]: F1128 18:05:27.064279     884 server.go:156] unknown flag: --allow-privileged
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£å†³æ–¹å¼ï¼Œåœ¨ /etc/kubernetes/kubelet.env ç§»é™¤ <code>KUBE_ALLOW_PRIV=&quot;--allow-privileged=true&quot;</code> å¹¶åœ¨  /etc/systemd/system/kubelet.service ç§»é™¤ <code>$KUBE_ALLOW_PRIV</code> ç¯å¢ƒå˜é‡å¼•ç”¨ã€‚</p>
</li>
<li>
<p>coredns deployments æ–° Pod æ— æ³•è¢«åˆ›å»ºï¼ŒåŸå› æ˜¯ kube-system ä¸­æœ‰è«åå…¶å¦™çš„ LimitRange èµ„æºï¼Œé™åˆ¶äº†å®¹å™¨æœ€å°èµ„æºè¯·æ±‚æœ€å° CPU ä¸º 100mï¼Œæœ€å° Memory ä¸º 100Miã€‚è§£å†³æ–¹å¼ï¼Œåˆ é™¤ LimitRange å³å¯ã€‚</p>
</li>
<li>
<p>è‡ªç ” AutoScaler ç»„ä»¶å¤±æ•ˆï¼Œä½¿ç”¨ label container_name çªç„¶å–ä¸åˆ° CPU Metrics æ•°æ®ã€‚åŸå› æ˜¯ 1.15 å <a href="https://github.com/kubernetes/kubernetes/pull/76074">kubernetes#76074 - change kubelet probe metrics to counter</a> ç§»é™¤äº† CPU Metrics label container_nameã€‚è§£å†³æ–¹å¼æ˜¯ä¿®æ”¹ Metrics æŸ¥è¯¢ä¸º label containerã€‚å¦‚æœä½¿ç”¨äº† label pod_nameï¼Œä¹Ÿåº”è¯¥ä¿®æ”¹ä¸º label podã€‚</p>
</li>
</ul>
<h2 id="115---116-è¸©å‘è®°å½•">1.15 -&gt; 1.16 è¸©å‘è®°å½•</h2>
<p>æ›´æ–°é•œåƒåˆ° <code>coredns:1.6.2</code> ä¹‹åï¼ŒCoreDNS Deployment ä¸‹çš„ Pod æ­£å¸¸ Running ä½†ä¸€ç›´æœª Readyã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master-0:/etc/kubernetes/upgrade# kubectl -n kube-system get po <span class="p">|</span> grep core
</span></span><span class="line"><span class="cl">coredns-8656b5f45f-gvbqd                  1/1     Running   <span class="m">1</span>          20h
</span></span><span class="line"><span class="cl">coredns-ddd4d886f-4nwd5                   0/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">coredns-ddd4d886f-nk9mp                   0/1     Running   <span class="m">0</span>          24m
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸå› æ˜¯ coreDNS 1.6 ä¹‹å readiness serve æ”¹ä¸ºäº†æ’ä»¶æ¨¡å¼ï¼Œè¯¦è§ <a href="https://github.com/coredns/coredns/issues/3219">coredns#3219 - Readiness probe failed 8181: connect: connection refused</a></p>
<p>è§£å†³æ–¹å¼ï¼š<code>kubectl -n kube-system edit cm coredns</code> æ¿€æ´» ready æ’ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">coredns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Corefile</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    .:53 {
</span></span></span><span class="line"><span class="cl"><span class="sd">        errors
</span></span></span><span class="line"><span class="cl"><span class="sd">        health {
</span></span></span><span class="line"><span class="cl"><span class="sd">            lameduck 5s
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">        kubernetes lac-k8s-prd.local in-addr.arpa ip6.arpa {
</span></span></span><span class="line"><span class="cl"><span class="sd">            pods insecure
</span></span></span><span class="line"><span class="cl"><span class="sd">            fallthrough in-addr.arpa ip6.arpa
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">        prometheus :9153
</span></span></span><span class="line"><span class="cl"><span class="sd">        ready :8181 # å¢åŠ è¿™ä¸€è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="sd">        forward . /etc/resolv.conf {
</span></span></span><span class="line"><span class="cl"><span class="sd">            max_concurrent 1000
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">        cache 30
</span></span></span><span class="line"><span class="cl"><span class="sd">        loop
</span></span></span><span class="line"><span class="cl"><span class="sd">        reload
</span></span></span><span class="line"><span class="cl"><span class="sd">        loadbalance
</span></span></span><span class="line"><span class="cl"><span class="sd">    }</span><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="118---119-è¸©å‘è®°å½•">1.18 -&gt; 1.19 è¸©å‘è®°å½•</h2>
<ul>
<li>feature gate <code>VolumeSubpathEnvExpansion</code> åœ¨ 1.19 è¢«ç§»é™¤ï¼Œå¯¼è‡´æ‰§è¡Œ <code>kubeadm upgrade</code> åï¼Œkube-apiserver, kube-controller-manager, kube-scheduler, kube-proxy, kubelet å‡æ— æ³•å¯åŠ¨ã€‚è§£å†³æ–¹å¼
<ol>
<li>æå‰è‡ª kubeadm ClusterConfiguration ä¸­ç§»é™¤ <code>feature-gates: VolumeSubpathEnvExpansion=true</code>ã€‚ä¸€èˆ¬æ˜¯ç½®ç©º <code>- --feature-gates=</code>ã€‚</li>
<li>æå‰è‡ª kube-proxy ConfigMap ç§»é™¤ <code>feature-gates: VolumeSubpathEnvExpansion=true</code>ã€‚</li>
<li>æå‰è‡ª /etc/kubernetes/kubelet.env ç§»é™¤ <code>feature-gates: VolumeSubpathEnvExpansion=true</code>ã€‚ï¼ˆ<code>sed -i '/--feature-gates=VolumeSubpathEnvExpansion=true \\/d'  /etc/kubernetes/kubelet.env</code></li>
</ol>
</li>
<li>è§¦å‘ Prometheus å‘Šè­¦: ğŸ˜±ğŸš€ KubeScheduler/KubeControllerManager has disappeared from Prometheus target discoveryã€‚
åŸå› æ˜¯ Prometheus ä½¿ç”¨ HTTP EndPoints <host>:10251/ready æ¢æµ‹ KubeScheduler æ˜¯å¦å°±ç»ªï¼Œä½†åœ¨ 1.19 ç§»é™¤äº†è¿™ä¸€é»˜è®¤ç«¯å£ã€‚
è¯¦è§ <a href="https://github.com/kubernetes/kubeadm/issues/2207">kubeadm#2207 - remove &ndash;port from kube-controller-manager and kube-scheduler</a>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">up{endpoint=&#34;http-metrics&#34;,instance=&#34;10.40.34.34:10251&#34;,job=&#34;kube-scheduler&#34;,namespace=&#34;kube-system&#34;,pod=&#34;kube-scheduler-master0&#34;,service=&#34;basic-kube-scheduler&#34;} 
</span></span><span class="line"><span class="cl">0
</span></span></code></pre></td></tr></table>
</div>
</div>è§£å†³æ–¹å¼ï¼Œè‡ªå·± kube-scheduler å’Œ kube-controller-manager manifest åˆ é™¤å¯åŠ¨å‚æ•° <code>- --port=0</code>ï¼ˆ<code>sed -i '/- --port=0/d'  /etc/kubernetes/manifests/kube-scheduler.yaml  /etc/kubernetes/manifests/kube-controller-manager.yaml</code></li>
<li>éƒ¨åˆ† Webhook è¯ä¹¦çªç„¶å¤±æ•ˆ
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2023-11-30T14:46:44.577+0800    ERROR ... 
</span></span><span class="line"><span class="cl">err: Internal error occurred: 
</span></span><span class="line"><span class="cl">failed calling webhook \&#34;mutate-deploy.x.com\&#34;: 
</span></span><span class="line"><span class="cl">  Post \&#34;https://x.kube-system.svc:443/mutate-deployment?timeout=30s\&#34;: 
</span></span><span class="line"><span class="cl">    x509: certificate relies on legacy Common Name field, 
</span></span><span class="line"><span class="cl">      use SANs or temporarily enable Common Name matching with GODEBUG=x509ignoreCN=0&#34;
</span></span></code></pre></td></tr></table>
</div>
</div>è§£å†³æ–¹å¼ï¼Œæ›´æ–° kube-apiserver manifestsï¼Œç»™ Pod å¢åŠ ç¯å¢ƒå˜é‡å³å¯
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">env:
</span></span><span class="line"><span class="cl">- name: GODEBUG
</span></span><span class="line"><span class="cl">value: &#34;x509ignoreCN=0&#34;
</span></span></code></pre></td></tr></table>
</div>
</div>è¯¥æ–¹å¼åœ¨ 1.23 å‰æœ‰æ•ˆï¼Œè¯¦è§ <a href="https://cloud.google.com/kubernetes-engine/docs/deprecations/webhookcompatibility">GKE: Ensuring compatibility of webhook certificates before upgrading to v1.23</a></li>
</ul>
<h2 id="119---120-æ³¨æ„ç‚¹">1.19 -&gt; 1.20 æ³¨æ„ç‚¹</h2>
<ul>
<li>kubelet ä¼šä½¿ç”¨ pause:3.2ï¼Œéœ€è¦ä¿è¯ pause:3.2 åœ¨å†…ç½‘å¯æ‹‰å–</li>
<li>v1.19 è‡³ v1.20 æœ€å¤§å˜åŒ–å°±æ˜¯åºŸå¼ƒäº† <code>apiserver serve on an insecure port</code>ï¼Œå› æ­¤åœ¨å‡çº§å‰åº”è¯¥ä¿®æ”¹ kubeadm ClusterConfiguration ç§»é™¤ apiserver å‚æ•° <code>--insecure-bind-address</code> å’Œå‚æ•° <code>--insecure-port</code>ã€‚åŒæ—¶åº”è¯¥æ£€æŸ¥å·¦å³å®¢æˆ·ç«¯ kubeconfigï¼Œå¦‚æœä½¿ç”¨äº† HTTP è¿æ¥ kube-apiserverï¼Œåº”è¯¥æ›´æ–°è‡³ HTTPS ç‰ˆã€‚</li>
<li>ä¸ºå…¼å®¹ Prometheus HTTP æ¢æµ‹ kube-scheduler å’Œ kube-controller-managerï¼Œåº”è¯¥ç»§ç»­æ‰§è¡Œ <code>sed -i '/- --port=0/d'  /etc/kubernetes/manifests/kube-scheduler.yaml  /etc/kubernetes/manifests/kube-controller-manager.yaml</code></li>
<li>1.20 kubelet ç§»é™¤äº† endpoint <code>metrics/resource/v1alpha1</code>ï¼Œå¦‚æœ Prometheus é…ç½®äº†ä»è¯¥è·¯å¾„çˆ¬å– Metrics çš„ ServiceMonitorï¼Œéœ€ä¿®æ”¹å¯¹åº”èµ„æºï¼Œæ”¹æˆ <code>metrics/resource</code></li>
</ul>
<h2 id="120---121-æ³¨æ„ç‚¹">1.20 -&gt; 1.21 æ³¨æ„ç‚¹</h2>
<ul>
<li>kubelet ä¼šä½¿ç”¨ pause:3.4.1ï¼Œéœ€è¦ä¿è¯ pause:3.4.1 åœ¨å†…ç½‘å¯æ‹‰å–</li>
<li>ä¸ºå…¼å®¹ Prometheus HTTP æ¢æµ‹ kube-scheduler å’Œ kube-controller-managerï¼Œåº”è¯¥ç»§ç»­æ‰§è¡Œ <code>sed -i '/- --port=0/d'  /etc/kubernetes/manifests/kube-scheduler.yaml  /etc/kubernetes/manifests/kube-controller-manager.yaml</code></li>
<li>1.21 feature BoundServiceAccountTokenVolume é»˜è®¤å¯ç”¨åï¼ŒServiceAccount å‡­è¯ä» Secret æŒ‚è½½æ”¹ä¸ºåŠ¨æ€ Token è·å–ã€‚æŒ‰ç…§å£°æ˜æ¥çœ‹æŒ‚è½½æƒé™æ— å·®å¼‚ã€‚ä½†åœ¨ç”Ÿäº§é›†ç¾¤ä¸­ï¼ŒPod Container è®¾ç½® <code>securityContext.runAsUser: 101</code> ä»¥é root user è¿è¡Œæ—¶ï¼Œè¯»å– token æ–‡ä»¶æŠ¥é”™ <code>open /var/run/secrets/kubernetes.io/serviceaccount/token: permission denied</code> (container image: quay.io/kubernetes-ingress-controller/<a href="https://github.com/kubernetes/ingress-nginx/tree/controller-0.31.0">nginx-ingress-controller:0.31.0</a>)ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># before 1.21
</span></span><span class="line"><span class="cl">- name: nginx-ingress-serviceaccount-token-vqxzw
</span></span><span class="line"><span class="cl">  secret:
</span></span><span class="line"><span class="cl">    defaultMode: 420
</span></span><span class="line"><span class="cl">    secretName: nginx-ingress-serviceaccount-token-vqxzw
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"># after 1.21
</span></span><span class="line"><span class="cl">volumes:
</span></span><span class="line"><span class="cl">- name: kube-api-access-xbwws
</span></span><span class="line"><span class="cl">  projected:
</span></span><span class="line"><span class="cl">    defaultMode: 420
</span></span><span class="line"><span class="cl">    sources:
</span></span><span class="line"><span class="cl">    - serviceAccountToken:
</span></span><span class="line"><span class="cl">        expirationSeconds: 3607
</span></span><span class="line"><span class="cl">        path: token
</span></span><span class="line"><span class="cl">    - configMap:
</span></span><span class="line"><span class="cl">        items:
</span></span><span class="line"><span class="cl">        - key: ca.crt
</span></span><span class="line"><span class="cl">          path: ca.crt
</span></span><span class="line"><span class="cl">        name: kube-root-ca.crt
</span></span><span class="line"><span class="cl">    - downwardAPI:
</span></span><span class="line"><span class="cl">      items:
</span></span><span class="line"><span class="cl">      - fieldRef:
</span></span><span class="line"><span class="cl">          apiVersion: v1
</span></span><span class="line"><span class="cl">          fieldPath: metadata.namespace
</span></span><span class="line"><span class="cl">        path: namespace
</span></span></code></pre></td></tr></table>
</div>
</div>è§£å†³æ–¹å¼ï¼šä¸º Pod è®¾ç½® <code>spec.securityContext.fsGroup: 65534</code>ï¼Œç¡®ä¿æ‰€æœ‰ container å¯¹æŒ‚è½½ç›®å½•æœ‰è¯»å–æƒé™ã€‚</li>
</ul>
<h2 id="ç³»ç»Ÿçº§é•œåƒå‘ç‚¹">ç³»ç»Ÿçº§é•œåƒå‘ç‚¹</h2>
<p>å¦‚å› å†…ç½‘ç¯å¢ƒæˆ–è€…å…¶ä»–åŸå› å¯¼è‡´å›½å¤–é•œåƒä¸å¯è¾¾ï¼Œåº”è¯¥ä½¿ç”¨ <code>kubeadm apply &lt;targetVersion&gt; --dry-run</code> æ‰“å°æ‰§è¡Œç»“æœï¼Œé‡ç‚¹ grep å¦‚ä¸‹ç»„ä»¶é•œåƒå¹¶æå‰åšå¥½åˆ†å‘</p>
<ul>
<li>CoreDNS</li>
<li>pause</li>
</ul>
<p>å°èŠ‚ cluster çº§å‡çº§å¼€å¤´çš„é•œåƒåˆ†å‘æ˜¯èµ°å®Œæ•´ä¸ªæµç¨‹çš„æˆæœã€‚</p>
<h2 id="ä»»æ„-worker-èŠ‚ç‚¹æ›´æ–°">ä»»æ„ worker èŠ‚ç‚¹æ›´æ–°</h2>
<p>èµ°å®Œ control plane èŠ‚ç‚¹æ›´æ–°ï¼Œä¹Ÿå°±è¸©å®Œäº†æ™®é€š worker èŠ‚ç‚¹çš„å‘ã€‚è„šåŒ–å¤„ç†å³å¯ã€‚æ‰¾ä¸€å°å¯ä»¥ç™»é™†æ‰€æœ‰ worker çš„æœºå™¨ï¼Œå‡†å¤‡è„šæœ¬ <code>upgrade-worker.sh</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">VERSION</span><span class="o">=</span>v1.21.14
</span></span><span class="line"><span class="cl"><span class="nv">UPGRADEDIR</span><span class="o">=</span>/etc/kubernetes/upgrade
</span></span><span class="line"><span class="cl">mkdir -p <span class="nv">$UPGRADEDIR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">wget -O <span class="nv">$UPGRADEDIR</span>/kubeadm-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubeadm
</span></span><span class="line"><span class="cl">chmod +x <span class="nv">$UPGRADEDIR</span>/kubeadm-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">wget -O <span class="nv">$UPGRADEDIR</span>/kubelet-<span class="nv">$VERSION</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$VERSION</span>/bin/linux/amd64/kubelet
</span></span><span class="line"><span class="cl">chmod +x <span class="nv">$UPGRADEDIR</span>/kubelet-<span class="nv">$VERSION</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># start of updating args, it depends on your kubelet&#39;s status, don&#39;t use it</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/# Should this cluster be allowed to run privileged docker containers/d; /KUBE_ALLOW_PRIV=&#34;--allow-privileged=true&#34;/d&#39;</span> /etc/kubernetes/kubelet.env
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/\$KUBE_ALLOW_PRIV \\/d&#39;</span> /etc/systemd/system/kubelet.service
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/--feature-gates=VolumeSubpathEnvExpansion=true \\/d&#39;</span>  /etc/kubernetes/kubelet.env
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|google-containers/pause-amd64:3.1|google-containers/pause:3.4.1|&#39;</span> /etc/kubernetes/kubelet.env
</span></span><span class="line"><span class="cl"><span class="c1"># end of updating args, it depends on your kubelet&#39;s status, don&#39;t use it</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$UPGRADEDIR</span>/kubeadm-<span class="nv">$VERSION</span> upgrade node
</span></span><span class="line"><span class="cl">mv <span class="nv">$UPGRADEDIR</span>/kubelet-<span class="nv">$VERSION</span> /usr/local/bin/kubelet
</span></span><span class="line"><span class="cl">systemctl daemon-reload
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæŒ‰ç…§å®é™…ä¸šåŠ¡æƒ…å†µï¼Œåˆ†æ‰¹æ¬¡å®Œæˆ kubelet v1.14 è‡³ v1.21 å‡çº§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> NODE in work-1 work-2 work-3<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    kubectl drain <span class="nv">$NODE</span> --ignore-daemonsets --delete-local-data
</span></span><span class="line"><span class="cl">    ssh <span class="nv">$NODE</span> <span class="s2">&#34;bash -s&#34;</span> -- &lt; /etc/kubernetes/upgrade/upgrade-worker.sh
</span></span><span class="line"><span class="cl">    kubectl uncordon <span class="nv">$NODE</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„: kubelet æ›´æ–°æ—¶çš„å‚æ•°æ›´æ–°ï¼Œå¦‚ <code>å‚æ•°ç§»é™¤</code>ï¼Œ <code>feature-gates ç§»é™¤</code>ï¼Œ <code>pause container æ›´æ–°</code> ç­‰ï¼Œå…·ä½“å› å®é™…é›†ç¾¤è€Œå¼‚ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>é›†ç¾¤å‡çº§æ¦‚è¦</p>
<ol>
<li>å…ˆæµ‹è¯•é›†ç¾¤åç”Ÿäº§é›†ç¾¤ï¼Œå…ˆå°é›†ç¾¤åå¤§é›†ç¾¤</li>
<li>æå‰å¤‡ä»½ etcdï¼Œè™½ç„¶æœ¬æ–‡æ²¡ç”¨ä¸Šå¤‡ä»½ ğŸ‘»</li>
<li>æŸ¥é˜… <a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">Kubernetes CHANGELOG</a>ï¼Œæ³¨æ„æ–°ç‰ˆæœ¬æ ¸å¿ƒç»„ä»¶çš„å‚æ•°ç§»é™¤ï¼Œå°¤å…¶æ˜¯ feature gates ç§»é™¤ä¼šæ¶‰åŠæ‰€æœ‰ <code>kube-</code> æ‰“å¤´ç»„ä»¶</li>
<li>æå‰ <code>kubeadm upgrade &lt;version&gt; --dryrun</code> æ£€æŸ¥æ–°ç‰ˆæœ¬é•œåƒï¼Œåšå¥½ CoreDNS å’Œ puase å®¹å™¨é•œåƒåˆ†å‘</li>
<li>upgrade å®Œæˆåï¼Œæ£€æŸ¥ CoreDNS å’Œ kube-proxy æ‰€æœ‰ Pod çŠ¶æ€ï¼Œç¡®ä¿æ›´æ–°å®Œæˆï¼›æ£€æŸ¥é›†ç¾¤ DNS åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼›æ£€æŸ¥é›†ç¾¤ Service åŠŸèƒ½æ˜¯å¦æ­£å¸¸</li>
<li>æ¯æ¬¡ upgrade å®Œæˆï¼Œæ£€æŸ¥ Operator/Controller å’Œå…³é”®ä¸šåŠ¡åº”ç”¨æ˜¯å¦æ­£å¸¸ï¼ˆå…³æ³¨æ—¥å¿—/ç›‘æ§/å‘Šè­¦ï¼‰ï¼Œæ£€æŸ¥æ ¸å¿ƒ API CRUD æ˜¯å¦æ­£å¸¸ï¼ˆé˜²æ­¢ Webhook å´©åï¼‰</li>
</ol>
<p>Container Runtime æ›´æ–°éƒ¨åˆ†ã€æœ€ç»ˆæ“ä½œæ–¹å¼å’Œè„šæœ¬è¯·æŸ¥é˜… <a href="../2024-kubernetes-upgrade-lessons">Kubernetes v1.14.5 â†’ v1.21.14 å‡çº§è¡¥é—åŠç»éªŒæ•™è®­</a>ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<ul>
<li>TauCeti.blog&rsquo;s Kubernetes upgrade notes: <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.14-1.15/">1.14-1.15</a>, <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.15-1.16/">1.15-1.16</a>, <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.16-1.17/">1.16-1.17</a>, <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.17-1.18/">1.17-1.18</a>, <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.17-1.18/">1.18-1.19</a>, <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.17-1.18/">1.19-1.20</a>, <a href="https://www.tauceti.blog/posts/kubernetes-upgrade-nodes-1.20-1.21/">1.20-1.21</a></li>
<li><a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide">Deprecated API Migration Guide</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">Upgrading kubeadm clusters</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">Kubernetes CHANGELOG</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Zeng Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2024-05-24 16:38
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">æœ¬ä½œå“é‡‡ç”¨ <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®®</a> è¿›è¡Œè®¸å¯ï¼Œè½¬è½½æ—¶è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ã€‚</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2023-retriable-http-client/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Notes on Retriable HTTP Client (with Golang/Rust example</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2023-kubevirt-mix-kubeovn-calico/">
            <span class="next-text nav-default">Calico â• KubeOVN â€”â€” ä¸º KubeVirt VMs æä¾›å—é™çš„ underlay ç½‘ç»œè®¿é—®</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2023-11-30 16:58:24 \u002b0800 CST',
        title: 'v1.14.5 - v1.21.14 Kubernetes è·¨ç‰ˆæœ¬å‡çº§è®°å½•',
        clientID: '6ab3c721bb197ea92f1e',
        clientSecret: '217d38cc1905f60f1d963c555be606ed3e707937',
        repo: 'phosae.github.io',
        owner: 'phosae',
        admin: ['phosae'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zenngxu@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/phosae" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/u/1566013967" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://www.zeng.dev/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zeng Xu</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEPN2KZF84"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FEPN2KZF84');
        }
      </script>
    
  











</body>
</html>
