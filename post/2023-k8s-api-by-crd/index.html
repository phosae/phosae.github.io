<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>K8s CustomResourceDefinitions (CRD) 原理 - ZengXu&#39;s BLOG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zeng Xu" /><meta name="description" content="K8s CustomResourceDefinition internals" /><meta name="keywords" content="kubernetes, rest" />






<meta name="generator" content="Hugo 0.109.0 with theme even" />


<link rel="canonical" href="https://www.zeng.dev/post/2023-k8s-api-by-crd/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.3ab191e0444a0833d62fa8f1e44231fc793f2c04a2474a8b9348894c550f8388.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="K8s CustomResourceDefinitions (CRD) 原理" />
<meta property="og:description" content="K8s CustomResourceDefinition internals" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zeng.dev/post/2023-k8s-api-by-crd/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-05-19T10:09:09+08:00" />
<meta property="article:modified_time" content="2023-05-27T17:29:00+08:00" />
<meta itemprop="name" content="K8s CustomResourceDefinitions (CRD) 原理">
<meta itemprop="description" content="K8s CustomResourceDefinition internals"><meta itemprop="datePublished" content="2023-05-19T10:09:09+08:00" />
<meta itemprop="dateModified" content="2023-05-27T17:29:00+08:00" />
<meta itemprop="wordCount" content="5382">
<meta itemprop="keywords" content="kubernetes,rest," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s CustomResourceDefinitions (CRD) 原理"/>
<meta name="twitter:description" content="K8s CustomResourceDefinition internals"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">
        <li class="mobile-menu-item">杂文</li>
      </a><a href="/about">
        <li class="mobile-menu-item">我</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">杂文</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">我</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">K8s CustomResourceDefinitions (CRD) 原理</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-05-19 10:09 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#-goals">🎯 Goals</a></li>
    <li><a href="#-hands-on-api-by-crd">🎮 Hands on API by CRD</a></li>
    <li><a href="#-api-discovery">🔍 API Discovery</a></li>
    <li><a href="#-api-by-crd-internals">🤔 API by CRD internals</a></li>
    <li><a href="#-generate-crd-from-go-structs">🧰 Generate CRD from Go Structs</a></li>
    <li><a href="#-summarize">📝 Summarize</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- 系列链接 -->
<p>本文为 <strong>K8s API 和控制器</strong> 系列文章之一</p>
<ul>
<li><a href="../2023-k8s-api-by-crd">CustomResourceDefinitions (CRD) 原理</a> (本文)</li>
<li><a href="../2023-k8s-apiserver-from-scratch">实现一个极简 apiserver</a></li>
<li><a href="../2023-k8s-apiserver-aggregation-internals">搞懂 apiserver aggregation</a></li>
<li><a href="../2023-k8s-api-codegen">最不厌其烦的 K8s 代码生成教程</a></li>
<li><a href="../2023-k8s-apiserver-using-library">使用 library 实现 K8s apiserver</a></li>
<li><a href="../2023-k8s-apiserver-avoid-using-runtime">慎重选用 Runtime 类框架开发 K8s apiserver</a></li>
</ul>
<h2 id="-goals">🎯 Goals</h2>
<p>这里假定你已经熟悉 Kubernetes 的基本组件，尤其是 Control Plane 之核心 kube-apiserver，如不然，可以移步<a href="https://kubernetes.io/docs/concepts/overview/components/">这里</a>。</p>
<p>kube-apiserver 的所有资源都归属于不同组，以 API Group 方式对外暴露 <a href="https://kubernetes.io/docs/reference/using-api/#api-groups">[1]</a></p>
<ul>
<li>核心/默认组 (core/legacy group) 比较特殊，它的组名为空字符串，前缀为 <code>/api</code>，可以通过 REST HTTP 路径 <code>/api/v1</code> 访问，如 <code>/api/v1/pods</code>, <code>/api/v1/namespaces/default/configmaps</code></li>
<li>其他资源 REST HTTP 路径前缀为 <code>/apis</code>，格式一律为 <code>/apis/{group}/{version}</code>，如 <code>/apis/apps/v1</code>，<code>/apis/autoscaling/v2</code></li>
</ul>
<p>用户可以使用 kubectl 操作这些资源 (CRUD)</p>
<table>
<thead>
<tr>
<th>Pod</th>
<th>Deployment</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>kubectl run foo &ndash;image nginx</td>
<td>kubectl create deploy/foo &ndash;image nginx</td>
<td>create</td>
</tr>
<tr>
<td>kubectl create -f ./pod-nginx.yml</td>
<td>kubectl create -f ./deploy-nginx.yml</td>
<td>create</td>
</tr>
<tr>
<td>kubectl get pod foo</td>
<td>kubectl get  deploy foo</td>
<td>get</td>
</tr>
<tr>
<td>kubectl apply -f ./pod-foo.yml</td>
<td>kubectl apply -f ./deploy-foo.yml</td>
<td>update or create</td>
</tr>
<tr>
<td>kubectl delete pod foo</td>
<td>kubectl delete deploy foo</td>
<td>delete</td>
</tr>
</tbody>
</table>
<p>注意到不需要指明 Deployment 对应 Group apps 也可操作成功，因为 kube-apiserver 中并无其他名称复数为 deploys/deployments 的资源。如果多个 Group 存在相同名字资源，则需要通过 <code>{kind_plural}.{group}</code> 唯一标识资源，类似这样 <code>kubectl get deployments.apps foo</code>。</p>
<p>我们现在开始拓展 kube-apiserver API，目标是在其中增设一个资源组 <code>hello.zeng.dev</code>，HTTP REST Path 为 <code>/apis/hello.zeng.dev/</code>。且资源 <code>foos.hello.zeng.dev</code> 可被 kubectl CRUD</p>
<table>
<thead>
<tr>
<th>by KindName</th>
<th>by GroupKindName</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>kubectl create -f ./foo.yml</td>
<td>kubectl create -f ./foo.yml</td>
<td>create</td>
</tr>
<tr>
<td>kubectl get foo myfoo</td>
<td>kubectl get hello.zeng.dev.foos myfoo</td>
<td>get</td>
</tr>
<tr>
<td>kubectl apply -f ./foos.yml</td>
<td>kubectl apply -f ./foos.yml</td>
<td>update or create</td>
</tr>
<tr>
<td>kubectl delete foo myfoo</td>
<td>kubectl delete hello.zeng.dev.foos myfoo</td>
<td>delete</td>
</tr>
</tbody>
</table>
<h2 id="-hands-on-api-by-crd">🎮 Hands on API by CRD</h2>
<p>最简单的方式是在集群中创建 CustomResourceDefinition 对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">cat &lt;&lt; EOF | kubectl apply -f -</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiextensions.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CustomResourceDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 固定格式 {kind_plural}.{group}，其中 foos 对应 spec.names.plural，hello.zeng.dev 对应 spec.group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foos.hello.zeng.dev </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">hello.zeng.dev</span><span class="w"> </span><span class="c"># 资源组，用在 URL 标识资源所属 Group，如 /apis/hello.zeng.dev/v1/foos 之 hello.zeng.dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listKind</span><span class="p">:</span><span class="w"> </span><span class="l">FooList</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l">foos </span><span class="w"> </span><span class="c"># 资源名复数，用在 URL 标识资源类型，如 /apis/hello.zeng.dev/v1/foos 之 foos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w"> </span><span class="c"># 资源名单数，可用于 kubectl 匹配资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shortNames</span><span class="p">:</span><span class="w">   </span><span class="c"># 资源简称，可用于 kubectl 匹配资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">fo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">Namespaced</span><span class="w"> </span><span class="c"># Namespaced/Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">versions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 是否启用该版本，可使用该标识启动/禁用该版本 API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 唯一落存储版本，如果 CRD 含有多个版本，只能有一个版本被标识为 true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">msg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">additionalPrinterColumns</span><span class="p">:</span><span class="w"> </span><span class="c"># 声明 kubectl get 输出列，默认在 name 列之外额外输出 age 列，改为额外输出 age 列，message 列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.metadata.creationTimestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.spec.msg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建 crd/foos.hello.zeng.dev 之后，即可用 kubectl 直接操作 foo 资源。操作体验和官方资源 Pod，Service 等相比并无二致。</p>
<img src="/img/2023/api-crd-crudfoo.gif" width="700px"/>
<h2 id="-api-discovery">🔍 API Discovery</h2>
<p>kubectl 如何知道 kube-apiserver 存在某项资源 fo？如何知道 fo 是资源 foos 的简称？如何知道 foos 属于哪个资源 Group？如何知道 foos 支持什么操作？这就涉及到 Kubernetes 的 API Discovery 机制。</p>
<p>调整日志级别可以发现：kubectl 在向 kube-apiserver 发起 <code>GET /apis/hello.zeng.dev/v1/namespaces/default/foos</code> 之前。会先查询 /api 和 /apis</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get fo --cache-dir <span class="k">$(</span>mktemp -d<span class="k">)</span> -v <span class="m">6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I0524 02:24:45.787217 <span class="m">1446906</span> loader.go:373<span class="o">]</span> Config loaded from file:  /root/.kube/config
</span></span><span class="line"><span class="cl">I0524 02:24:45.806835 <span class="m">1446906</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:41485/api?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">17</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 02:25:36.529247 <span class="m">1446951</span> round_trippers.go:463<span class="o">]</span> GET https://127.0.0.1:41485/apis?timeout<span class="o">=</span>32s
</span></span><span class="line"><span class="cl">I0524 02:24:45.829483 <span class="m">1446906</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:41485/apis/hello.zeng.dev/v1/namespaces/default/foos?limit<span class="o">=</span><span class="m">500</span> <span class="m">200</span> OK in <span class="m">5</span> milliseconds
</span></span><span class="line"><span class="cl">No resources found in default namespace.
</span></span></code></pre></td></tr></table>
</div>
</div><p>调整 kubectl 日志级别为 8 拿到 Accept Header 更改输出 application/json -&gt; application/yaml，curl kube-apiserver /apis</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on top terminal</span>
</span></span><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="c1"># on bottom terminal, Kubernetes 1.27.2</span>
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;Accept: application/yaml;g=apidiscovery.k8s.io;v=v2beta1;as=APIGroupDiscoveryList&#39;</span> localhost:8001/apis
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: apidiscovery.k8s.io/v2beta1
</span></span><span class="line"><span class="cl">kind: APIGroupDiscoveryList
</span></span><span class="line"><span class="cl">metadata: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">items:
</span></span><span class="line"><span class="cl">- metadata:
</span></span><span class="line"><span class="cl">    creationTimestamp: null
</span></span><span class="line"><span class="cl">    name: hello.zeng.dev
</span></span><span class="line"><span class="cl">  versions:
</span></span><span class="line"><span class="cl">  - version: v1
</span></span><span class="line"><span class="cl">    resources:
</span></span><span class="line"><span class="cl">    - resource: foos
</span></span><span class="line"><span class="cl">      responseKind:
</span></span><span class="line"><span class="cl">        group: hello.zeng.dev
</span></span><span class="line"><span class="cl">        kind: Foo
</span></span><span class="line"><span class="cl">        version: v1
</span></span><span class="line"><span class="cl">      scope: Namespaced
</span></span><span class="line"><span class="cl">      shortNames:
</span></span><span class="line"><span class="cl">      - fo
</span></span><span class="line"><span class="cl">      singularResource: foo
</span></span><span class="line"><span class="cl">      verbs:
</span></span><span class="line"><span class="cl">      - delete
</span></span><span class="line"><span class="cl">      - deletecollection
</span></span><span class="line"><span class="cl">      - get
</span></span><span class="line"><span class="cl">      - list
</span></span><span class="line"><span class="cl">      - patch
</span></span><span class="line"><span class="cl">      - create
</span></span><span class="line"><span class="cl">      - update
</span></span><span class="line"><span class="cl">      - watch
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到如下 REST API 信息</p>
<ul>
<li>kube-apiserver 有一个 API Group <code>hello.zeng.dev</code></li>
<li>Group <code>hello.zeng.dev</code> 含有许多 <code>versions</code></li>
<li>版本 <code>v1</code> 内含资源 <code>foos</code>，scope 级别为 <code>Namespaced</code></li>
<li><code>foos</code> 资源简称为 <code>fo</code></li>
<li><code>foos</code> 资源支持操作动词为 <code>delete</code>, <code>deletecollection</code>, <code>get</code>, <code>list</code>, <code>patch</code>, <code>create</code>, <code>update</code>, <code>watch</code></li>
</ul>
<p>获取对应 REST API 信息后，kubectl 发现 fo 是资源复数为 <code>foos</code> 的简称，其对应 group 为 <code>hello.zeng.dev</code>，其默认版本为 <code>v1</code>，于是发起请求 <code>GET/POST/PATCH/DELETE /apis/hello.zeng.dev/v1/namespaces/default/foos</code>，而抛出错误 <code>error: the server doesn't have a resource type &quot;fo&quot;</code></p>
<p>⚠️😵 注意 😵⚠️</p>
<p>返回类型 <code>application/yaml;g=apidiscovery.k8s.io;v=v2beta1;as=APIGroupDiscoveryList</code> 由 <a href="https://github.com/kubernetes/enhancements/issues/3352">Feature Aggregated Discovery</a> 实现，支持一次调用获取所有 API Group/Resource 信息，于 1.26 进入 alpha 状态（默认关闭），1.27 进入 beta（默认开启）</p>
<p>一般地，kube-apiserver 中所有 REST API resouces 均可按照如下层次发现（核心/默认组放在特殊路径 <code>/api</code>，它没有 Group（或者说 Group 是空字符串）</p>
<ol>
<li>GET <code>/api</code> ➡️ APIVersions or APIGroupDiscoveryList (1.27+)</li>
<li>GET <code>/apis</code> ➡️ APIGroupList or APIGroupDiscoveryList (1.27+)</li>
<li>GET <code>/apis/{group}</code> ➡️ APIGroup (optional, contained in <code>/apis</code>)</li>
<li>GET <code>/apis/{group}/{version}</code> or <code>/api/v1</code> ➡️ APIResourceList</li>
</ol>
<p>kubectl api-resources 包含了整个发现过程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Kubernetes 1.26.4 (1.27-</span>
</span></span><span class="line"><span class="cl">kubectl api-resources --cache-dir <span class="k">$(</span>mktemp -d<span class="k">)</span> -v <span class="m">6</span> <span class="p">|</span> awk <span class="s1">&#39;NR==1 || /pods|fo|deploy/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I0524 08:05:12.629151 <span class="m">1472208</span> loader.go:373<span class="o">]</span> Config loaded from file:  /root/.kube/config
</span></span><span class="line"><span class="cl">I0524 08:05:12.645780 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/api?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">14</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.650105 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">2</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.655089 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/authorization.k8s.io/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">3</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.655874 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/api/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">4</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.655935 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/authentication.k8s.io/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">4</span> milliseconds
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">I0524 08:05:12.659065 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/hello.zeng.dev/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">6</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.721295 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/hello.zeng.dev/v1/namespaces/default/foos?limit<span class="o">=</span><span class="m">500</span> <span class="m">200</span> OK in <span class="m">43</span> milliseconds
</span></span><span class="line"><span class="cl">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND
</span></span><span class="line"><span class="cl">pods                              po           v1                                     <span class="nb">true</span>         Pod
</span></span><span class="line"><span class="cl">deployments                       deploy       apps/v1                                <span class="nb">true</span>         Deployment
</span></span><span class="line"><span class="cl">foos                              fo           hello.zeng.dev/v1                      <span class="nb">true</span>         Foo
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认情况下 kube-apiverser <code>GET /apis</code> 返回 APIGroupList (包含所有 API Groups 信息），再逐个访问 <code>/apis/{group}/{version}</code> 得到 APIResourceList。最终汇聚出 kube-apiserver 支持的所有 Resource 信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on top terminal</span>
</span></span><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;Accept: application/yaml&#39;</span> localhost:8001/apis 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kind: APIGroupList
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">groups:
</span></span><span class="line"><span class="cl">- name: autoscaling
</span></span><span class="line"><span class="cl">  versions:
</span></span><span class="line"><span class="cl">  - groupVersion: autoscaling/v2
</span></span><span class="line"><span class="cl">    version: v2
</span></span><span class="line"><span class="cl">  - groupVersion: autoscaling/v1
</span></span><span class="line"><span class="cl">    version: v1
</span></span><span class="line"><span class="cl">  preferredVersion:
</span></span><span class="line"><span class="cl">    groupVersion: autoscaling/v2
</span></span><span class="line"><span class="cl">    version: v2
</span></span><span class="line"><span class="cl">- name: hello.zeng.dev
</span></span><span class="line"><span class="cl">  versions:
</span></span><span class="line"><span class="cl">  - groupVersion: hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">    version: v1
</span></span><span class="line"><span class="cl">  preferredVersion:
</span></span><span class="line"><span class="cl">    groupVersion: hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">    version: v1
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;Accept: application/yaml&#39;</span> localhost:8001/apis/hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">groupVersion: hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">kind: APIResourceList
</span></span><span class="line"><span class="cl">resources:
</span></span><span class="line"><span class="cl">- kind: Foo
</span></span><span class="line"><span class="cl">  name: foos
</span></span><span class="line"><span class="cl">  namespaced: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  shortNames:
</span></span><span class="line"><span class="cl">  - fo
</span></span><span class="line"><span class="cl">  singularName: foo
</span></span><span class="line"><span class="cl">  storageVersionHash: <span class="nv">YAqgrOjs43I</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - delete
</span></span><span class="line"><span class="cl">  - deletecollection
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - patch
</span></span><span class="line"><span class="cl">  - create
</span></span><span class="line"><span class="cl">  - update
</span></span><span class="line"><span class="cl">  - watch
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，APIGroupDiscoveryList 其实是 APIGroupList 加上所有 APIResourceList，作用是减少 API Discovery 的请求次数 (n -&gt; 1)。</p>
<h2 id="-api-by-crd-internals">🤔 API by CRD internals</h2>
<p>kube-apiserver 包含两个模块：kube-apiserver 模块和 <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a>，前者负责官方核心组 core/legacy (Pod, ConfigMap, Service 等) 和官方普通 Groups (apps, autoscaling, batch) 资源的处理，后者负责 CRD 及对应 Custom Resources 处理。</p>
<blockquote>
<p>🤣🤣🤣
「kube-apiserver 包含 kube-apiserver 模块」 —— 听着很奇怪。Kubernetes 起初只有 kube-apiserver 模块提供官方 API，并不支持 Custom Resources。1.6 之后相继引入 CustomResourceDefinitions（也即 <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a>，见 <a href="https://github.com/kubernetes/enhancements/issues/95">issue 95</a>）和 kube-aggregator 模块（支持 API Aggregation 功能，见 <a href="https://github.com/kubernetes/enhancements/issues/263">issue 263</a>）支持 Custom Resources。</p>
</blockquote>
<p><a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a> 功能，由多个内置 controllers 驱动。比较重要的控制器是 controllers 是 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/501bf5ec6db2f5e9171a8ed822380f71911b1b8f/pkg/apiserver/customresource_discovery_controller.go#L59">DiscoveryController</a>（负责 API Discovery）、OpenAPI 控制器（OpenAPI Spec），和 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a>（负责资源的增删改查）。其他的还有 CRD 状态字段更新、对应 custom resource 名称检查、CRD 删除清理等，代码集中在 <a href="https://github.com/kubernetes/apiextensions-apiserver/tree/master/pkg/controller">这个 package</a>。</p>
<p><a href="https://github.com/kubernetes/apiextensions-apiserver/blob/501bf5ec6db2f5e9171a8ed822380f71911b1b8f/pkg/apiserver/customresource_discovery_controller.go#L59">DiscoveryController</a> 实现了之前展示的 API Discovery。它不断监听 CRD 变化，负责将 CRD 声明同步转化为以下内存对象</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/apidiscovery/v2beta1/types.go#L33-L66">APIGroupDiscovery</a> (1.26+)</li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/0bff705acd8982e34b937116eb2016c9d6e4c4a6/staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/types.go#L1045-L1076">APIGroup</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/0bff705acd8982e34b937116eb2016c9d6e4c4a6/staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/types.go#L1098-L1155">APIResourceList</a></li>
</ul>
<p>并动态注册以下 API 返回对应资源</p>
<ul>
<li><code>/apis/{group}</code> ➡️ APIGroup</li>
<li><code>/apis/{group}/{version}</code> ➡️ APIResourceList</li>
</ul>
<p>在本文例子中，动态注册的路由是 <code>/apis/hello.zeng.dev</code> 和 <code>/apis/hello.zeng.dev/v1</code>。</p>
<p>在 1.26+ APIGroupDiscovery 则会提供给 kube-apiserver 中的全局 <a href="https://github.com/kubernetes/kubernetes/blob/b374404825125f5ea8c46313ccaf3717e6ba46fb/staging/src/k8s.io/apiserver/pkg/server/config.go#L278">AggregatedDiscoveryGroupManager</a>，最终统一聚合在 <code>/apis</code>。1.26 之前，<code>/apis</code> 路径只返回 APIGroupList。</p>
<p>得益于 OpenAPI 控制器，CRD 创建后，自 kube-apiserver /openapi/v3 或者 /openapi/v2 查询 hello.zeng.dev/v1 的 OpenAPISpec，即可得到如下结果（只展示了 3 层 JSON，完整内容在 <a href="/file/hello.zeng.dev_v1_openapi_v3.json">这里</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on top terminal</span>
</span></span><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="c1"># on bottom terminal, or curl -s http://localhost:8001/openapi/v3/apis/hello.zeng.dev/v1 | jq &#39;del(.[]?[]?[]?[]?)&#39;</span>
</span></span><span class="line"><span class="cl">curl -s http://localhost:8001/openapi/v3/apis/hello.zeng.dev/v1 <span class="p">|</span> jq <span class="s1">&#39;delpaths([path(.), path(..) | select(length &gt;3)])&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;openapi&#34;</span>: <span class="s2">&#34;3.0.0&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;info&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;title&#34;</span>: <span class="s2">&#34;Kubernetes CRD Swagger&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;version&#34;</span>: <span class="s2">&#34;v0.1.0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;paths&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/apis/hello.zeng.dev/v1/foos&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;get&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;parameters&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;get&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;post&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;delete&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;parameters&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos/{name}&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;get&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;put&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;delete&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;patch&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;parameters&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;components&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;schemas&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;dev.zeng.hello.v1.Foo&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;dev.zeng.hello.v1.FooList&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.DeleteOptions&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.FieldsV1&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.ListMeta&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.ManagedFieldsEntry&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.ObjectMeta&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.OwnerReference&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Patch&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Preconditions&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Status&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.StatusCause&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.StatusDetails&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Time&#34;</span>: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OpenAPI 控制器有两个：<a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapi/controller.go">OpenAPIController v2</a> 和 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapiv3/controller.go">OpenAPIController v3</a>，分别支持 <a href="https://swagger.io/specification/v2/">OpenAPI Specification v2</a> 和 <a href="https://spec.openapis.org/oas/v3.1.0">OpenAPI Specification v3</a>。<strong>接口响应体字段</strong> schemas 对应 CRD 对象字段 <code>.spec.versions[].schema</code>， <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapi/controller.go">OpenAPIController v2</a> 和 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapiv3/controller.go">OpenAPIController v3</a> 会监听 CRD 变化、自动生成 OpenAPISpec 并将其写入 kube-apiserver 模块 OpenAPI Spec，由 kube-apiserver 路由 /openapi/v2 和 /openapi/v3 对外暴露。</p>
<p>OpenAPISpec 则类似使用说明书，它提供了使用 API 的规范：包括接收参数、数据格式约束、操作动词、返回数据类型等。稍微修改 CRD OpenAPI 定义，要求 <code>spec.msg</code> 为必输，且长度不超过 15</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;msg&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 新增字段必输校验</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">msg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">maxLength</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="c"># 新增长度上限校验</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可校验效果如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | k apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: hello.zeng.dev/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Foo
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: invalid
</span></span></span><span class="line"><span class="cl"><span class="s">spec: {}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The Foo <span class="s2">&#34;invalid&#34;</span> is invalid: spec.msg: Required value
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | k apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: hello.zeng.dev/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Foo
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: invalid
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  msg: &#34;hello world, hello world&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">The Foo <span class="s2">&#34;invalid&#34;</span> is invalid: spec.msg: Too long: may not be longer than <span class="m">15</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/img/2023/crd-custom-resource-validation.gif" width="600px"/>
<p>此外可以看到，创建 Foo 不遵从如下结构会报错</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: hello.zeng.dev/v1 | apiVersion: v1  &lt;--- 使用何种 API 版本创建资源
</span></span><span class="line"><span class="cl">kind: Foo                     | kind: Pod       &lt;--- 欲创建资源类型
</span></span><span class="line"><span class="cl">metadata:                     | metadata:       &lt;--- 唯一标识资源的元数据，包括 name
</span></span><span class="line"><span class="cl">  name: myfoo                 |   name: web              namespace（默认值为 default）, UID（省略则在服务端自动生成) 等
</span></span><span class="line"><span class="cl">spec:                         | spec:           &lt;--- 所期望的资源状态（What state you desire for the object
</span></span><span class="line"><span class="cl">  msg: hi                     |   containers:            通常搭配 status 使用，当前阶段的 Foo 还不涉及，后续文章会做介绍
</span></span><span class="line"><span class="cl">                              |   - name: nginx  
</span></span><span class="line"><span class="cl">                              |     image: nginx
</span></span></code></pre></td></tr></table>
</div>
</div><p>它们是 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/#required-fields">Kubernetes objects 必须字段</a> 。尽管 CRD OpenAPIV3 Schema 并不包含 apiVersion, kind 和 metadata 字段， <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a> 会 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/e0b0416bf23396ad7fb7007b264f5c04062590bc/pkg/registry/customresource/validator.go">强制保证这些字段</a>。</p>
<p>🪬🪬🪬 Kubernetes 1.25+ <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation-rules">CRD validation rules</a> 进入 beta，可在 OpenAPI Spec 基础上设置更强大的字段约束。</p>
<p>🪬🪬🪬 kubectl apply 会利用 OpenAPI Spec 确定资源支持的 Patch 类型，kubectl explain 输出的资源字段来自于 OpenAPI Spec。kubectl 插件 <a href="https://github.com/kubernetes-sigs/kubectl-validate">kubernetes-sigs/kubectl-validate</a> 支持在客户端使用 OpenAPI Spec 校验资源对象（接近 <code>--dry-run=server</code>）。</p>
<p>解释了 API Discovery 如何可能和如何使用 API 之后，到达了最后一个问题：<strong>API 资源处理和持久如何可能?</strong></p>
<p>这得从路由层说起，kube-apiserver <a href="https://github.com/kubernetes/kubernetes/blob/e11c5284ad01554b60c29b8d3f6337f2c735e7fb/cmd/kube-apiserver/app/server.go#L192-L208">通过委托模式串联 apiextensions-apiserver 模块</a> 获得了 CRD 处理能力</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kube-apiserver ---&gt; {core/legacy group /api/**}, {official groups /apis/apps/**, /apis/batch/**, ...}
</span></span><span class="line"><span class="cl">    │
</span></span><span class="line"><span class="cl"> delegate
</span></span><span class="line"><span class="cl">    │
</span></span><span class="line"><span class="cl">    └── apiextensions-apiserver ---&gt; {CRD groups /apis/apiextensions.k8s.io/**, /apis/&lt;crd.group.io&gt;/**}
</span></span><span class="line"><span class="cl">                      │
</span></span><span class="line"><span class="cl">                   delegate
</span></span><span class="line"><span class="cl">                      │
</span></span><span class="line"><span class="cl">                      └── notfoundhandler ---&gt; 404 NotFound
</span></span></code></pre></td></tr></table>
</div>
</div><p>HTTP 请求路由流程如下</p>
<ul>
<li>先从 kube-apiserver 模块开始路由匹配，如果匹配核心组路由 <code>/api/**</code> 或者<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.27/#-strong-api-groups-strong-">官方 API Groups</a> 如 <code>/apis/apps/**</code>，<code>/apis/batch/**</code>，直接在本模块处理。如果不匹配，委托给 apiextensions-apiserver 处理</li>
<li><a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a> 先看请求是否匹配路由 <code>/apis/apiextensions.k8s.io/**</code>，如果是则为 customresourcedefinitions 变更，直接在本模块处理；如果不匹配，再看是否匹配任意 CRD 对应的 Custom 路由 <code>/apis/{crd_group}/**</code>，如果任一匹配，直接在本模块处理。否则委托给 notfoundhandler 处理</li>
<li>notfoundhandler 返回 HTTP 404</li>
</ul>
<p>回顾之前的 OpenAPI Spec，可以发现 <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a> 自动为 CRD 生成了这些 REST API</p>
<ul>
<li>/apis/hello.zeng.dev/v1/foos</li>
<li>/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos</li>
<li>/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos/{name}</li>
</ul>
<p>原理是模块内 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a> 提供了 <code>/apis/{group}/{version}/({kind_plural} | namespaces/{namespace}/{kind_plural} | namespaces/{namespace}/{kind_plural}/{name})</code> 通配。<a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a> 实时读取所有 CRD 信息，负责 custom resources 的 CRUD 操作，并持有一个 <a href="https://github.com/kubernetes/apiextensions-apiserver/tree/master/pkg/registry/customresource">RESTStorage</a> (实现通常为 etcd)。在 API 层业务（通用校验、解码转换、admission 等）成功后，<a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a> 调用 RESTStorage 实施对象持久化。</p>
<p>路由 <code>/apis</code> 实际是 <code>/apis/{group}/{version}</code> 和 <code>/apis/{group}</code> 的聚合，由 kube-apiserver 的 kube-aggregator 模块提供，将在后面章节介绍。</p>
<p>总结上述内容如下</p>
<img src="/img/2023/crd-2discovery-2resource.png" width="888px"/>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">                      +--- DiscoveryController sync ---&gt; HTTP Endpoints /apis/{group},/apis/{group}/{version}
</span></span><span class="line"><span class="cl">                      |
</span></span><span class="line"><span class="cl">CRD &lt;---listwatch---&gt; +--- OpenApiController sync ---&gt; OpenAPI Spec in kube-apiserver module
</span></span><span class="line"><span class="cl">                      |
</span></span><span class="line"><span class="cl">                      +--- customresource_handler CRUDs
</span></span><span class="line"><span class="cl">                           +---&gt; /apis/{group}/{version}/foos
</span></span><span class="line"><span class="cl">                           +---&gt; /apis/{group}/{version}/namespaces/{namespace}/{kind_plural}
</span></span><span class="line"><span class="cl">                           +---&gt; /apis/{group}/{version}/namespaces/{namespace}/{kind_plural}/{name}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="-generate-crd-from-go-structs">🧰 Generate CRD from Go Structs</h2>
<p>手动维护 CRD 对象是笨办法，更好的方式是从 Go Struct 生成 CRD 声明。<a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a> 项目的一个工具 <a href="https://github.com/kubernetes-sigs/controller-tools/tree/master/cmd/controller-gen">controller-gen</a> 提供了这种能力。</p>
<p>我的项目 <a href="https://github.com/phosae/x-kubernetes">x-kubernetes</a> 统一将 API 相关 Go Structs 放置在目录 /api 中，按照 /api/{group} 罗列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">~/x-kubernetes# tree api -L 3
</span></span><span class="line"><span class="cl">api
</span></span><span class="line"><span class="cl">└── hello.zeng.dev
</span></span><span class="line"><span class="cl">    └── v1
</span></span><span class="line"><span class="cl">        ├── types.go
</span></span><span class="line"><span class="cl">        └── ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>types.go 内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">v1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Foo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">Spec</span> <span class="nx">FooSpec</span> <span class="s">`json:&#34;spec&#34; protobuf:&#34;bytes,2,opt,name=spec&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">FooSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Msg says hello world!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Msg</span> <span class="kt">string</span> <span class="s">`json:&#34;msg&#34; protobuf:&#34;bytes,1,opt,name=msg&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Msg1 provides some verbose information
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Msg1</span> <span class="kt">string</span> <span class="s">`json:&#34;msg1&#34; protobuf:&#34;bytes,2,opt,name=msg1&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">FooList</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ListMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">Items</span> <span class="p">[]</span><span class="nx">Foo</span> <span class="s">`json:&#34;items&#34; protobuf:&#34;bytes,2,rep,name=items&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在项目 /api 目录，执行 crd 生成脚本 update-crd-docker.sh</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~/x-kubernetes/api# ./hack/update-crd-docker.sh 
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者在 /api 目录直接跑 controller-gen</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">controller-gen schemapatch:manifests<span class="o">=</span>./artifacts/crd <span class="nv">paths</span><span class="o">=</span>./... output:dir<span class="o">=</span>./artifacts/crd
</span></span></code></pre></td></tr></table>
</div>
</div><p>即可动态生成 OpenAPI schemas (changes trace: git diff a5469c0 38dcc40 -- artifacts/crd/hello.zeng.dev_foos.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiextensions.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CustomResourceDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foos.hello.zeng.dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">hello.zeng.dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listKind</span><span class="p">:</span><span class="w"> </span><span class="l">FooList</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l">foos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">Namespaced</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">versions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">additionalPrinterColumns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.metadata.creationTimestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.spec.msg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.spec.msg1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="w">       </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+        openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+          type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+          required</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">+            - spec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+          properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            apiVersion</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              description: &#39;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info</span><span class="p">:</span><span class="w"> </span><span class="l">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            kind</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              description: &#39;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info</span><span class="p">:</span><span class="w"> </span><span class="l">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              required</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">+                - msg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                msg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  description</span><span class="p">:</span><span class="w"> </span><span class="l">Msg says hello world!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                msg1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  description</span><span class="p">:</span><span class="w"> </span><span class="l">Msg1 provides some verbose information</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现 Go Structs 中含有 JSON Tags 的字段均被映射到了 OpenAPI Spec Properties，字段注释映射到了 description，字段类型映射到了 type。</p>
<p>⚠️⚠️⚠️ 注意：这里的 <code>controller-gen schemapatch</code>，作用使用 patch 仅更新文件 hello.zeng.dev_foos.yaml 中的 openAPIV3Schema。如果使用 <code>controller-gen crd</code>，则会重新生成整个文件。</p>
<ul>
<li><code>controller-gen crd:crdVersions=v1 paths=./... output:dir=./artifacts/crd</code> 生成完整CRD定义 ➡️ <a href="https://github.com/phosae/x-kubernetes/blob/38dcc4056984705ffbf9dbeaa570e875857a6042/api/artifacts/crd/hello.zeng.dev_foos_full.yaml">hello.zeng.dev_foos_full.yaml</a></li>
<li><code>controller-gen crd:crdVersions=v1,maxDescLen=0 paths=./... output:dir=./artifacts/crd</code> 生成不含注释的CRD定义 ➡️ <a href="https://github.com/phosae/x-kubernetes/blob/38dcc4056984705ffbf9dbeaa570e875857a6042/api/artifacts/crd/hello.zeng.dev_foos_nodesc.yaml">hello.zeng.dev_foos_nodesc.yaml</a></li>
</ul>
<p>这里没有引入需要学习成本的 <a href="https://book.kubebuilder.io/reference/markers/crd.html">generation markers</a>，故没法生成 additionalPrinterColumns 定义。也没有引入 <a href="https://book.kubebuilder.io/reference/markers/crd-validation.html">validation markers</a>，故没法生成字段校验 schema。</p>
<p>⚠️⚠️⚠️ 注意：CRD OpenAPI Schema 之 <code>properties/apiVersion, kind, metadata</code> ，虽然工具生成了这些字段定义，实际非必需（如之前展示）。apiextensions-apiserver 的 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/37c0f7d353bee5630da4b697c410b00acec91f11/pkg/controller/openapi/builder/builder.go#L381-L413">openapi builder</a> 会自动注入这些定义。</p>
<h2 id="-summarize">📝 Summarize</h2>
<p>CustomResourceDefinition 是拓展 K8s API 最便捷方式，没有之一。<a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver 模块</a> 有如下好处</p>
<ul>
<li>开箱即用，只需提供 CRD 声明，不需要自行实现 REST API（包括 OpenAPI Spec 转换、API Discovery、Custom Resource CRUD），也不需要与存储层交互</li>
<li>本身集成在 kube-apiserver 中，不需要处理鉴权（authentication）和授权（authorization）</li>
<li><a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>, <a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a> 等社区工具，可以一键生成 CRD 定义和对应的控制器脚手架</li>
</ul>
<p>而它的缺点也正是它的优点的反面（但对于规模不大的集群和大部分场景通常可以忍受</p>
<ul>
<li>存储限制较大，只能以 JSON 存储 etcd，其他存储需求无法满足，比如存储为 protobuf 以节约磁盘空间，比如 Custom Resource 仅存储在内存，仅存储在普通文件，需要存储在 MySQL, SQLite, PostgreSQL 等关系型数据库</li>
<li>API 绑定在 kube-apiserver 进程，无法单独对外提供服务，无法实施 API 分流，定制性低</li>
</ul>
<p>后续篇章会基于同样的 API 库，展示各种 custom apiserver 集成方式，方便比较优劣。</p>
<p>Custom API 往往需要配合控制器，才能发挥其强大能力。本文仅介绍了 CustomResourceDefinition 的使用姿势和实现原理。控制器相关将在后续篇章介绍。</p>
<!-- apiextensions-apiserver timeline -->
<!-- API Aggregation timeline -->

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Zeng Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-05-27 17:29
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本作品采用 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a> 进行许可，转载时请注明原文链接。</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/rest/">rest</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2023-k8s-apiserver-from-scratch/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">实现一个极简 K8s apiserver</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2023-kubeadm-enable-kubelet-serving-certs/">
            <span class="next-text nav-default">Enable Kubelet Serving Certificates in Kubernetes Setup by Kubeadmin</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2023-05-19 10:09:09 \u002b0800 CST',
        title: 'K8s CustomResourceDefinitions (CRD) 原理',
        clientID: '6ab3c721bb197ea92f1e',
        clientSecret: '217d38cc1905f60f1d963c555be606ed3e707937',
        repo: 'phosae.github.io',
        owner: 'phosae',
        admin: ['phosae'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zenngxu@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/phosae" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/u/1566013967" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://www.zeng.dev/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zeng Xu</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-FEPN2KZF84', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>










</body>
</html>
