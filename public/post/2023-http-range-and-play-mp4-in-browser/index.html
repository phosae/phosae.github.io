<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Http Range Request and MP4 Video Play in Browser - ZengXu&#39;s BLOG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zeng Xu" /><meta name="description" content="HTTP range request is a widely used feature when it comes to file resource. Besides covering basic concept of range request, this blog show how HTTP range request works in browsers. Behaviors of Chrome, FireFox and Safari are coverd. several sample HTTP servers written in Golang are used to trick browsers." /><meta name="keywords" content="http, go, range request, byte serving, web" />






<meta name="generator" content="Hugo 0.109.0 with theme even" />


<link rel="canonical" href="https://www.zeng.dev/post/2023-http-range-and-play-mp4-in-browser/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.3ab191e0444a0833d62fa8f1e44231fc793f2c04a2474a8b9348894c550f8388.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Http Range Request and MP4 Video Play in Browser" />
<meta property="og:description" content="HTTP range request is a widely used feature when it comes to file resource. Besides covering basic concept of range request, this blog show how HTTP range request works in browsers. Behaviors of Chrome, FireFox and Safari are coverd. several sample HTTP servers written in Golang are used to trick browsers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zeng.dev/post/2023-http-range-and-play-mp4-in-browser/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-03-08T10:51:20+08:00" />
<meta property="article:modified_time" content="2023-03-08T10:51:20+08:00" />
<meta itemprop="name" content="Http Range Request and MP4 Video Play in Browser">
<meta itemprop="description" content="HTTP range request is a widely used feature when it comes to file resource. Besides covering basic concept of range request, this blog show how HTTP range request works in browsers. Behaviors of Chrome, FireFox and Safari are coverd. several sample HTTP servers written in Golang are used to trick browsers."><meta itemprop="datePublished" content="2023-03-08T10:51:20+08:00" />
<meta itemprop="dateModified" content="2023-03-08T10:51:20+08:00" />
<meta itemprop="wordCount" content="2569">
<meta itemprop="keywords" content="http,go,range request,byte serving,web,en," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Http Range Request and MP4 Video Play in Browser"/>
<meta name="twitter:description" content="HTTP range request is a widely used feature when it comes to file resource. Besides covering basic concept of range request, this blog show how HTTP range request works in browsers. Behaviors of Chrome, FireFox and Safari are coverd. several sample HTTP servers written in Golang are used to trick browsers."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">
        <li class="mobile-menu-item">杂文</li>
      </a><a href="/about">
        <li class="mobile-menu-item">我</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">杂文</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">我</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Http Range Request and MP4 Video Play in Browser</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-03-08 10:51 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#basic-concept">Basic Concept</a></li>
    <li><a href="#how-range-requests-happen-in-browsers">How Range Requests happen in Browsers</a></li>
    <li><a href="#can-http-server-return-206-to-browser-for-the-first-request">Can HTTP Server return 206 to Browser for the First Request?</a></li>
    <li><a href="#can-server-side-control-the-size-of-each-range-request">Can Server Side Control the Size of Each Range Request?</a></li>
    <li><a href="#how-can-server-side-handle-video-stream-of-dynamic-size">How Can Server Side Handle Video Stream of Dynamic Size?</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="basic-concept">Basic Concept</h2>
<p>Splitting large video file into parts, transfering it over network part by part, are vital for browser
displaying video to user. The network may losing packet. The user may want to play at any random time point. The parts way can avoid retransmission and improve user experience.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">+----------------------------------------------------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                                           1000MB                                                   |  
</span></span><span class="line"><span class="cl">+----------------------------------------------------------------------------------------------------+
</span></span><span class="line"><span class="cl">                                              ↓                                             
</span></span><span class="line"><span class="cl">+--------+   +-------------+             +-----------------------------+        +--------------------+
</span></span><span class="line"><span class="cl">| 100MB  |   |    150MB    |    ......   |            300MB            |        |         200MB      |
</span></span><span class="line"><span class="cl">+--------+   +-------------+             +-----------------------------+        +--------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>In HTTP protocol 1.1 to achieve this range request can be leveraged. More backgroun and details are at HTTP <a href="https://www.rfc-editor.org/rfc/rfc7233">RFC7233</a>, Wiki <a href="https://en.wikipedia.org/wiki/Byte_serving">Byte_serving</a>.</p>
<p>Briefly, the HTTP Client send a request with header <code>Range</code> that declare needed byte ranges in resource. The HTTP server reponse with status code <code>206</code> (Partial Content), with header <code>Content-Range</code> describing what range of the selected representation is enclosed, and a payload consisting of the range.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HTTP Client                             HTTP Server
</span></span><span class="line"><span class="cl">+------------------------+              +-------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1    |              | HTTP/1.1 206 Partial Content        |
</span></span><span class="line"><span class="cl">| Host: example.com      |    &lt;-----&gt;   | Content-Range: bytes 0-1023/10240   |
</span></span><span class="line"><span class="cl">| Range: bytes=0-1023    |              | Content-Length: 1024                |
</span></span><span class="line"><span class="cl">+------------------------+              | ...                                 |
</span></span><span class="line"><span class="cl">                                        | (body: 1024 bytes of a.mp4)         |
</span></span><span class="line"><span class="cl">                                        +-------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the request range is invalid or don&rsquo;t overlap the selected resource, the server reponse with status code <code>416</code> (Range Not Satisfiable).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HTTP Client                               HTTP Server
</span></span><span class="line"><span class="cl">+--------------------------+              +-----------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1      |              | HTTP/1.1 416 Requested Range Not Satisfiable  |
</span></span><span class="line"><span class="cl">| Host: example.com        |    &lt;-----&gt;   | Content-Range: bytes */10240                  |
</span></span><span class="line"><span class="cl">| Range: bytes=10250-12000 |              | ...                                           |
</span></span><span class="line"><span class="cl">+--------------------------+              +-----------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>Examples of valid byte ranges (assuming a resource of length 10240):</p>
<ul>
<li><code>bytes=0-499</code>, the first 500 bytes</li>
<li><code>bytes=1000-1999</code>, 1000 bytes start from offset 1000</li>
<li><code>bytes=-500</code>, the final 500 bytes (byte offsets 9739-10239, inclusive)</li>
<li><code>bytes=0-0,-1</code>, the first and last bytes only</li>
<li><code>bytes=0-</code>, <code>bytes=0-10250</code>, be interpreted as <code>bytes=0-10239</code></li>
</ul>
<p>As <a href="https://www.rfc-editor.org/rfc/rfc7233">RFC7233</a> pointed out</p>
<blockquote>
<p>If the last-byte-pos value is absent, or if the value is greater than or equal to the current length of the representation data, the byte range is interpreted as the remainder of the representation</p>
</blockquote>
<h2 id="how-range-requests-happen-in-browsers">How Range Requests happen in Browsers</h2>
<p>How could the browser/client knows whether to send a range request and not? The answer is HTTP header <code>Accept-Ranges: bytes</code>.</p>
<p>Below is a example from Chrome that request and play a video (791MB) from Golang HTTP file server. It start with a normal HTTP request. By reading the response header from stream, Chrome find the server side supports range, then abort the connection and start sending range requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1. send request, read the onflight reponse header, close connection when range support detected
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chrome                                            Server
</span></span><span class="line"><span class="cl">+------------------------+    ------------&gt;       +-------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1    |   close conn when      | HTTP/1.1 200 OK                     |
</span></span><span class="line"><span class="cl">| Host: example.com      |    &lt;----x-------       | Accept-Ranges: bytes                |
</span></span><span class="line"><span class="cl">+------------------------+ range support detected | Content-Length: 828908177           |
</span></span><span class="line"><span class="cl">                                                  | ...                                 |
</span></span><span class="line"><span class="cl">                                                  | (body: some first bytes of a.mp4)   |
</span></span><span class="line"><span class="cl">                                                  +-------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2. send trivial range request 1, fetch head parts, verify server&#39;s support, 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chrome                                         Server
</span></span><span class="line"><span class="cl">+------------------------+   ------------&gt;     +---------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1    |  close conn when    | HTTP/1.1 206 Partial Content                |
</span></span><span class="line"><span class="cl">| Host: example.com      |   &lt;----x-------     | Accept-Ranges: bytes                        |
</span></span><span class="line"><span class="cl">| Range: [bytes=0-]      |   verify success    | Content-Range: bytes 0-828908176/828908177  |
</span></span><span class="line"><span class="cl">+------------------------+                     | Content-Length: 828908177                   |
</span></span><span class="line"><span class="cl">                                               | ...                                         |
</span></span><span class="line"><span class="cl">                                               | (body: some first bytes of a.mp4)           |
</span></span><span class="line"><span class="cl">                                               +---------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. send trivial range request 2, fetch tail parts, verify server&#39;s support 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chrome                                          Server
</span></span><span class="line"><span class="cl">+--------------------------+                    +-----------------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1      |                    | HTTP/1.1 206 Partial Content                        |
</span></span><span class="line"><span class="cl">| Host: example.com        |   -----------&gt;     | Accept-Ranges: bytes                                |
</span></span><span class="line"><span class="cl">| Range: bytes=828604416-  |                    | Content-Range: bytes 828604416-828908176/828908177  |
</span></span><span class="line"><span class="cl">+--------------------------+                    | Content-Length: 303761                              |
</span></span><span class="line"><span class="cl">                                                | ...                                                 |
</span></span><span class="line"><span class="cl">                                                | (body: some end bytes of a.mp4)                     |
</span></span><span class="line"><span class="cl">                                                +-----------------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4. sending range request for remaining bytes 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chrome                                           Server
</span></span><span class="line"><span class="cl">+--------------------------+                     +-----------------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1      |   ------------&gt;     | HTTP/1.1 206 Partial Content                        |
</span></span><span class="line"><span class="cl">| Host: example.com        |   &lt;------------     | Accept-Ranges: bytes                                |
</span></span><span class="line"><span class="cl">| Range: bytes=720896-     |                     | Content-Range: bytes 720896-828908176/828908177     |
</span></span><span class="line"><span class="cl">+--------------------------+                     | Content-Length: 828187281                           |
</span></span><span class="line"><span class="cl">                                                 | ...                                                 |
</span></span><span class="line"><span class="cl">                                                 | (body: rest bytes of a.mp4)                         |
</span></span><span class="line"><span class="cl">                                                 +-----------------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>FireFox&rsquo;s Behaviors are quite similar to Chrome, except that&rsquo;s only one trivial range request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1. send request, read the onflight reponse header, close connection when range support detected
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FireFox                                           Server
</span></span><span class="line"><span class="cl">+------------------------+    ------------&gt;       +-------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1    |   close conn when      | HTTP/1.1 200 OK                     |
</span></span><span class="line"><span class="cl">| Host: example.com      |    &lt;----x-------       | Accept-Ranges: bytes                |
</span></span><span class="line"><span class="cl">+------------------------+ range support detected | Content-Length: 828908177           |
</span></span><span class="line"><span class="cl">                                                  | ...                                 |
</span></span><span class="line"><span class="cl">                                                  | (body: some first bytes of a.mp4)   |
</span></span><span class="line"><span class="cl">                                                  +-------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2. send trivial range request, fetch tail parts, verify server&#39;s support 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FireFox                                          Server
</span></span><span class="line"><span class="cl">+--------------------------+                    +-----------------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1      |                    | HTTP/1.1 206 Partial Content                        |
</span></span><span class="line"><span class="cl">| Host: example.com        |   &lt;----------&gt;     | Accept-Ranges: bytes                                |
</span></span><span class="line"><span class="cl">| Range: bytes=828604416-  |                    | Content-Range: bytes 828604416-828908176/828908177  |
</span></span><span class="line"><span class="cl">+--------------------------+                    | Content-Length: 303761                              |
</span></span><span class="line"><span class="cl">                                                | ...                                                 |
</span></span><span class="line"><span class="cl">                                                | (body: some end bytes of a.mp4)                     |
</span></span><span class="line"><span class="cl">                                                +-----------------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. sending range request for remaining bytes 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FireFox                                         Server
</span></span><span class="line"><span class="cl">+--------------------------+                  +-----------------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1      |   &lt;----------&gt;   | HTTP/1.1 206 Partial Content                        |
</span></span><span class="line"><span class="cl">| Host: example.com        |                  | Accept-Ranges: bytes                                |
</span></span><span class="line"><span class="cl">| Range: bytes=1867776-    |                  | Content-Range: bytes 1867776-828908176/828908177    |
</span></span><span class="line"><span class="cl">+--------------------------+                  | Content-Length: 827040401                           |
</span></span><span class="line"><span class="cl">                                              | ...                                                 |
</span></span><span class="line"><span class="cl">                                              | (body: rest bytes of a.mp4)                         |
</span></span><span class="line"><span class="cl">                                              +-----------------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>Safari send first trivial range request with <code>bytes=0-1</code>, and other two trivial range requests like Chrome.</p>
<p>Both Chrome and FireFox send range request using byte range (i.e <code>bytes=1867776-</code>) with last-byte-pos value absent. But Safari always set the last-byte-pos.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1. send request 1, read the onflight reponse header, close connection when range support detected
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Safari                                         Server
</span></span><span class="line"><span class="cl">+------------------------+    ------------&gt;       +-------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1    |   close conn when      | HTTP/1.1 200 OK                     |
</span></span><span class="line"><span class="cl">| Host: example.com      |    &lt;----x-------       | Accept-Ranges: bytes                |
</span></span><span class="line"><span class="cl">+------------------------+ range support detected | Content-Length: 828908177           |
</span></span><span class="line"><span class="cl">                                                  | ...                                 |
</span></span><span class="line"><span class="cl">                                                  | (body: some first bytes of a.mp4)   |
</span></span><span class="line"><span class="cl">                                                  +-------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2. send trivial range request 1, fetch first two bytes, verify server&#39;s support, 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Safari                                       Server
</span></span><span class="line"><span class="cl">+------------------------+                   +---------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1    |                   | HTTP/1.1 206 Partial Content                |
</span></span><span class="line"><span class="cl">| Host: example.com      |   &lt;-----------&gt;   | Accept-Ranges: bytes                        |
</span></span><span class="line"><span class="cl">| Range: bytes=0-1       |                   | Content-Range: bytes 0-1/828908177          |
</span></span><span class="line"><span class="cl">+------------------------+                   | Content-Length: 2                           |
</span></span><span class="line"><span class="cl">                                             | ...                                         |
</span></span><span class="line"><span class="cl">                                             | (body: first two bytes of a.mp4)            |
</span></span><span class="line"><span class="cl">                                             +---------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. send trivial range request 2, fetch some first parts, verify server&#39;s support 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Safari                                            Server
</span></span><span class="line"><span class="cl">+---------------------------+   ------------&gt;     +---------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1       |  close conn when    | HTTP/1.1 206 Partial Content                |
</span></span><span class="line"><span class="cl">| Host: example.com         |   &lt;----x-------     | Accept-Ranges: bytes                        |
</span></span><span class="line"><span class="cl">| Range: bytes=0-828908176  |   verify success    | Content-Range: bytes 0-828908176/828908177  |
</span></span><span class="line"><span class="cl">+---------------------------+                     | Content-Length: 828908177                   |
</span></span><span class="line"><span class="cl">                                                  | ...                                         |
</span></span><span class="line"><span class="cl">                                                  | (body: some first bytes of a.mp4)           |
</span></span><span class="line"><span class="cl">                                                  +---------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. send trivial range request 3, fetch tail parts, verify server&#39;s support 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Safari                                                 Server
</span></span><span class="line"><span class="cl">+-----------------------------------+                  +----------------------------------------------------+
</span></span><span class="line"><span class="cl">| GET /a.mp4 HTTP/1.1               |                  | HTTP/1.1 206 Partial Content                       |
</span></span><span class="line"><span class="cl">| Host: example.com                 |   &lt;----------&gt;   | Accept-Ranges: bytes                               |
</span></span><span class="line"><span class="cl">| Range: bytes=828571648-828908176  |                  | Content-Range: bytes 828571648-828908176/828908177 |
</span></span><span class="line"><span class="cl">+-----------------------------------+                  | Content-Length: 336529                             |
</span></span><span class="line"><span class="cl">                                                       | ...                                                |
</span></span><span class="line"><span class="cl">                                                       | (body: some end bytes of a.mp4)                    |
</span></span><span class="line"><span class="cl">                                                       +----------------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4. sending serial range requests for remaining bytes 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">req bytes=30.5-30.9MB
</span></span><span class="line"><span class="cl">req bytes=30.9-63.2MB
</span></span><span class="line"><span class="cl">req bytes=31.0-63.3MB
</span></span><span class="line"><span class="cl">req bytes=39.5-790MB (close conn when desired bytes from offset 39.5MB received)
</span></span><span class="line"><span class="cl">req bytes=42.3-790MB (close conn when desired bytes from offset 42.3MB received)
</span></span><span class="line"><span class="cl">req bytes=45.7-790MB (close conn when desired bytes from offset 45.7MB received)
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">req bytes=780.8-790MB (may close conn when desired bytes from offset 780.8MB received)
</span></span><span class="line"><span class="cl">req bytes=784.2-790MB (may close conn when desired bytes from offset 784.2MB received)
</span></span><span class="line"><span class="cl">req bytes=788.1-790MB (may close conn when desired bytes from offset 788.1MB received)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Whiles Chrome/FireFox try fetching the remaining bytes in one range request (with range without last-byte-pos i.e bytes=720896-), Safari sends many range request. It firstly request some small parts from the sever, wait for completion. In the next, Safari ask for all remaining bytes ranging from the bytes it holds to the end of file. But once every 4-5MB was transmitted from the server, Safari close the connection and start a new one.</p>
<p>So what happens when user drag the progress bar to any time point? The browser just mapping the desired the point of video to an offset from start,then it abort the inflight range request and start a new one like <code>byte=offset-total</code>.</p>
<h2 id="can-http-server-return-206-to-browser-for-the-first-request">Can HTTP Server return 206 to Browser for the First Request?</h2>
<p>Maybe yes, but meaningless.</p>
<p>The server return <code>206</code>(Partial Content) directly for browser&rsquo;s first request (the request without Range header). As sample code  show</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">sizePerRequst</span> <span class="p">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">httpRange</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">start</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">rangeVideo</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="nx">rangeHeader</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Range&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">rangeHeader</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ra</span> <span class="o">:=</span> <span class="nx">httpRange</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">start</span><span class="p">:</span>  <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">length</span><span class="p">:</span> <span class="nx">sizePerRequst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Accept-Ranges&#34;</span><span class="p">,</span> <span class="s">&#34;bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatInt</span><span class="p">(</span><span class="nx">ra</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Range&#34;</span><span class="p">,</span> <span class="nx">ra</span><span class="p">.</span><span class="nf">contentRange</span><span class="p">(</span><span class="nx">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusPartialContent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;hint browser to send serial range requests, response 206, 0-%d/%d\n&#34;</span><span class="p">,</span> <span class="nx">sizePerRequst</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="s">&#34;HEAD&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">written</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">CopyN</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">ra</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">written</span> <span class="o">!=</span> <span class="nx">ra</span><span class="p">.</span><span class="nx">length</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;desired range size: %d, actual written: %d, err: %v\n\n&#34;</span><span class="p">,</span> <span class="nx">ra</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Browsers include Chrome, FireFox, Safari handle this condition well. Sample server can play with docker and visit <a href="http://localhost:9100">localhost:9100</a> to see browser&rsquo;s behavior</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --rm -p 9100:9100 zengxu/go-http-range
</span></span></code></pre></td></tr></table>
</div>
</div><p>Full sample code is <a href="https://github.com/phosae/samples/tree/main/2023/go-http-range">here</a>.</p>
<h2 id="can-server-side-control-the-size-of-each-range-request">Can Server Side Control the Size of Each Range Request?</h2>
<p>Demands like [<a href="https://stackoverflow.com/questions/36114598/how-to-make-browser-request-smaller-range-with-206-partial-content">how-to-make-browser-request-smaller-range-with-206-partial-content</a>] are exist in server side.</p>
<p>Chrome and FireFox ask for ranges like <code>bytes=300-</code>,  can server side return a smaller-range part, other than part from offset 300 to end of file? The answer is yes.</p>
<p>Blow code sample shows that, when last-byte-pos is absent, set a position 5,000,000 bytes from the start position.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">httpRange</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">start</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">parseRange</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">size</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">([]</span><span class="nx">httpRange</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="nx">b</span> <span class="p">=</span> <span class="s">&#34;bytes=&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ra</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">):],</span> <span class="s">&#34;,&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Cut</span><span class="p">(</span><span class="nx">ra</span><span class="p">,</span> <span class="s">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">r</span> <span class="nx">httpRange</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">end</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">r</span><span class="p">.</span><span class="nx">length</span> <span class="p">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">length</span> <span class="p">&gt;</span> <span class="nx">size</span><span class="o">-</span><span class="nx">r</span><span class="p">.</span><span class="nx">start</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span><span class="p">.</span><span class="nx">length</span> <span class="p">=</span> <span class="nx">size</span> <span class="o">-</span> <span class="nx">r</span><span class="p">.</span><span class="nx">start</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">end</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">r</span><span class="p">.</span><span class="nx">start</span> <span class="p">&gt;</span> <span class="nx">i</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid range&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">size</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span> <span class="p">=</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">r</span><span class="p">.</span><span class="nx">length</span> <span class="p">=</span> <span class="nx">i</span> <span class="o">-</span> <span class="nx">r</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This works well with Chrome and FireFox. The browser will send serial range request, like <code>bytes=5_000_300-</code>, <code>bytes=10_000_300-</code>, <code>bytes=15_000_300-</code>, until the end of file reached.</p>
<p>The full sample code is <a href="https://github.com/phosae/samples/tree/main/2023/go-http-range">here</a>. You can run the server in Docker and visit <a href="http://localhost:9100/">localhost:9100</a> in Chrome or FireFox to verify result</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --rm -p 9100:9100 zengxu/go-http-range
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>::1<span class="o">]</span>:58426 request range <span class="nv">bytes</span><span class="o">=</span>3244032-
</span></span><span class="line"><span class="cl">response range bytes 3244032-8244031, <span class="m">4882</span> KB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>::1<span class="o">]</span>:58426 request range <span class="nv">bytes</span><span class="o">=</span>8244032-
</span></span><span class="line"><span class="cl">response range bytes 8244032-13244031, <span class="m">4882</span> KB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>::1<span class="o">]</span>:58426 request range <span class="nv">bytes</span><span class="o">=</span>13244032-
</span></span><span class="line"><span class="cl">response range bytes 13244032-18244031, <span class="m">4882</span> KB
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>::1<span class="o">]</span>:58426 request range <span class="nv">bytes</span><span class="o">=</span>53244032-
</span></span><span class="line"><span class="cl">response range bytes 53244032-53591653, <span class="m">339</span> KB
</span></span></code></pre></td></tr></table>
</div>
</div><p>As Safari always set the last-byte-pos, if the server response another last-byte-pos than desired position, the browser reject to play the video.</p>
<h2 id="how-can-server-side-handle-video-stream-of-dynamic-size">How Can Server Side Handle Video Stream of Dynamic Size?</h2>
<p>The sample server <a href="https://github.com/phosae/samples/tree/main/2023/go-http-range-dynamic">go-http-range-dynamic</a> returns 5,000,000 bytes for each range request of Chrome or FireFox (For Safari it depends on). when the range start of request is close the end of file, replace file with a large one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">rangeVideo</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">f</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">openfile</span><span class="p">(</span><span class="nx">vpart1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ranges</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">parseRange</span><span class="p">(</span><span class="nx">rangeHeader</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ra</span> <span class="o">:=</span> <span class="nx">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">ra</span><span class="p">.</span><span class="nx">start</span><span class="o">+</span><span class="nx">sizePerRequst</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="o">&amp;&amp;</span> <span class="nx">ra</span><span class="p">.</span><span class="nx">length</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="cm">/* try escape the tail verify */</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">openfile</span><span class="p">(</span><span class="nx">vfull</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Last two range request looks like this, the server try to update the resource size from 43730385 to 95644582. All browser have same behavior, they reject to fetch more streams and finish play the video.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Browser                                 Server
</span></span><span class="line"><span class="cl">+------------------------+              +--------------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET / HTTP/1.1         |              | HTTP/1.1 206 Partial Content                     |
</span></span><span class="line"><span class="cl">| Host: localhost        |    &lt;-----&gt;   | Content-Range: bytes 37359296-42359295/43730385  |
</span></span><span class="line"><span class="cl">| Range: bytes=37359296- |              | Content-Length: 5000000                          |
</span></span><span class="line"><span class="cl">+------------------------+              | ...                                              |
</span></span><span class="line"><span class="cl">                                        | (body: 5000000 bytes of video)                   |
</span></span><span class="line"><span class="cl">                                        +--------------------------------------------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Browser                                 Server
</span></span><span class="line"><span class="cl">+------------------------+              +--------------------------------------------------+           
</span></span><span class="line"><span class="cl">| GET / HTTP/1.1         |              | HTTP/1.1 206 Partial Content                     |
</span></span><span class="line"><span class="cl">| Host: localhost        |    &lt;-----&gt;   | Content-Range: bytes 42359296-43730384/95644582  |
</span></span><span class="line"><span class="cl">| Range: bytes=42359296- |              | Content-Length: 1371089                          |
</span></span><span class="line"><span class="cl">+------------------------+              | ...                                              |
</span></span><span class="line"><span class="cl">                                        | (body: 1371089 bytes of video)                   |
</span></span><span class="line"><span class="cl">                                        +--------------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>This sample server can run in Docker directly</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --rm -p 9100:9100 zengxu/go-http-range:dynamic
</span></span></code></pre></td></tr></table>
</div>
</div><p>What if the server side return a size large enough (i.e 100GB) as <code>Content-Length</code> header value for the first time browser requesting resource? Would the browser continually send range requests util 100GB reached? Answer is no. The browser may have some way to detect the actual size of first video(during head/tail verification), when its end reached, they reject to fetch more streams and exit the video play.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Range: bytes=0-          &lt;---&gt;   Content-Range: bytes 0-4999999/1000000000
</span></span><span class="line"><span class="cl">Range: bytes=4999999-    &lt;---&gt;   Content-Range: bytes 4999999-9999999/1000000000
</span></span><span class="line"><span class="cl">Range: bytes=9999999-    &lt;---&gt;   Content-Range: bytes 9999999-14999999/1000000000
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Range: bytes=9999999-    &lt;---&gt;   Content-Range: bytes 994999999-999999999/1000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Try sample server with option <code>-dynamic true</code> to verify browser&rsquo;s behavior</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run --rm -p 9100:9100 zengxu/go-http-range:dynamic -dynamic <span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Bypassing browser&rsquo;s verification need knowledges in video encoding technology and is tricky. The best solution for serving dynamic stream is write a custom one, popular video platforms like <a href="https://www.youtube.com">YouTube</a>, <a href="https://www.twitch.tv">Twitch</a> all use their own video player.</p>
<h2 id="conclusion">Conclusion</h2>
<p>HTTP range request is a widely used feature when it comes to file resource. File systems such as <a href="https://docs.aws.amazon.com/whitepapers/latest/s3-optimizing-performance-best-practices/use-byte-range-fetches.html">S3</a> have good support for this. Learning internals about range request helps you building HTTP system with higher aggregate throughput, for both server side and client side.</p>
<p>Browsers are quite smart with range request. Tricks sometimes works, but sometimes not. Obeying <a href="https://www.rfc-editor.org/rfc/rfc7233">RFC7233</a> is the best practice guide. HTTP range request is not a good solution for serving dynamic content. If you are building a site for livestream, it&rsquo;s better to come up with custom player.</p>
<hr>
<p>Further Reading</p>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests">MDN range request</a></li>
<li><a href="https://en.wikipedia.org/wiki/Byte_serving">Wiki Byte_serving</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc7233">RFC7233</a></li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Zeng Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-03-08 10:51
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本作品采用 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a> 进行许可，转载时请注明原文链接。</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/http/">http</a>
          <a href="/tags/go/">go</a>
          <a href="/tags/range-request/">range request</a>
          <a href="/tags/byte-serving/">byte serving</a>
          <a href="/tags/web/">web</a>
          <a href="/tags/en/">en</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2023-rest-part1-api/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">REST: Part 1 - HTTP API 设计思路</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2023-handle-container-terminating/">
            <span class="next-text nav-default">Terminate Container in Responsive and Graceful Way</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2023-03-08 10:51:20 \u002b0800 CST',
        title: 'Http Range Request and MP4 Video Play in Browser',
        clientID: '6ab3c721bb197ea92f1e',
        clientSecret: '217d38cc1905f60f1d963c555be606ed3e707937',
        repo: 'phosae.github.io',
        owner: 'phosae',
        admin: ['phosae'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zenngxu@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/phosae" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/u/1566013967" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://www.zeng.dev/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zeng Xu</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-FEPN2KZF84"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-FEPN2KZF84', { 'anonymize_ip': false });
}
</script>










</body>
</html>
