<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>K8s CustomResourceDefinitions (CRD) åŸç† - ZengXu&#39;s BLOG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zeng Xu" /><meta name="description" content="K8s CustomResourceDefinition internals" /><meta name="keywords" content="kubernetes, rest" />






<meta name="generator" content="Hugo 0.109.0 with theme even" />


<link rel="canonical" href="https://www.zeng.dev/post/2023-k8s-api-by-crd/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.3ab191e0444a0833d62fa8f1e44231fc793f2c04a2474a8b9348894c550f8388.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="K8s CustomResourceDefinitions (CRD) åŸç†" />
<meta property="og:description" content="K8s CustomResourceDefinition internals" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zeng.dev/post/2023-k8s-api-by-crd/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-05-19T10:09:09+08:00" />
<meta property="article:modified_time" content="2023-05-27T17:29:00+08:00" />
<meta itemprop="name" content="K8s CustomResourceDefinitions (CRD) åŸç†">
<meta itemprop="description" content="K8s CustomResourceDefinition internals"><meta itemprop="datePublished" content="2023-05-19T10:09:09+08:00" />
<meta itemprop="dateModified" content="2023-05-27T17:29:00+08:00" />
<meta itemprop="wordCount" content="5382">
<meta itemprop="keywords" content="kubernetes,rest," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s CustomResourceDefinitions (CRD) åŸç†"/>
<meta name="twitter:description" content="K8s CustomResourceDefinition internals"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">ä¸»é¡µ</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">
        <li class="mobile-menu-item">æ‚æ–‡</li>
      </a><a href="/about">
        <li class="mobile-menu-item">æˆ‘</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">ä¸»é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://www.notion.so/zengxu/Zeng-Xu-s-Little-World-a6b002fb4d134333abe74a4e0491cea7">æ‚æ–‡</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">æˆ‘</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">K8s CustomResourceDefinitions (CRD) åŸç†</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-05-19 10:09 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#-goals">ğŸ¯ Goals</a></li>
    <li><a href="#-hands-on-api-by-crd">ğŸ® Hands on API by CRD</a></li>
    <li><a href="#-api-discovery">ğŸ” API Discovery</a></li>
    <li><a href="#-api-by-crd-internals">ğŸ¤” API by CRD internals</a></li>
    <li><a href="#-generate-crd-from-go-structs">ğŸ§° Generate CRD from Go Structs</a></li>
    <li><a href="#-summarize">ğŸ“ Summarize</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- ç³»åˆ—é“¾æ¥ -->
<p>æœ¬æ–‡ä¸º <strong>K8s API å’Œæ§åˆ¶å™¨</strong> ç³»åˆ—æ–‡ç« ä¹‹ä¸€</p>
<ul>
<li><a href="../2023-k8s-api-by-crd">CustomResourceDefinitions (CRD) åŸç†</a> (æœ¬æ–‡)</li>
<li><a href="../2023-k8s-apiserver-from-scratch">å®ç°ä¸€ä¸ªæç®€ apiserver</a></li>
<li><a href="../2023-k8s-apiserver-aggregation-internals">ææ‡‚ apiserver aggregation</a></li>
<li><a href="../2023-k8s-api-codegen">æœ€ä¸åŒå…¶çƒ¦çš„ K8s ä»£ç ç”Ÿæˆæ•™ç¨‹</a></li>
<li><a href="../2023-k8s-apiserver-using-library">ä½¿ç”¨ library å®ç° K8s apiserver</a></li>
<li><a href="../2023-k8s-apiserver-avoid-using-runtime">æ…é‡é€‰ç”¨ Runtime ç±»æ¡†æ¶å¼€å‘ K8s apiserver</a></li>
</ul>
<h2 id="-goals">ğŸ¯ Goals</h2>
<p>è¿™é‡Œå‡å®šä½ å·²ç»ç†Ÿæ‚‰ Kubernetes çš„åŸºæœ¬ç»„ä»¶ï¼Œå°¤å…¶æ˜¯ Control Plane ä¹‹æ ¸å¿ƒ kube-apiserverï¼Œå¦‚ä¸ç„¶ï¼Œå¯ä»¥ç§»æ­¥<a href="https://kubernetes.io/docs/concepts/overview/components/">è¿™é‡Œ</a>ã€‚</p>
<p>kube-apiserver çš„æ‰€æœ‰èµ„æºéƒ½å½’å±äºä¸åŒç»„ï¼Œä»¥ API Group æ–¹å¼å¯¹å¤–æš´éœ² <a href="https://kubernetes.io/docs/reference/using-api/#api-groups">[1]</a></p>
<ul>
<li>æ ¸å¿ƒ/é»˜è®¤ç»„ (core/legacy group) æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„ç»„åä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå‰ç¼€ä¸º <code>/api</code>ï¼Œå¯ä»¥é€šè¿‡ REST HTTP è·¯å¾„ <code>/api/v1</code> è®¿é—®ï¼Œå¦‚ <code>/api/v1/pods</code>, <code>/api/v1/namespaces/default/configmaps</code></li>
<li>å…¶ä»–èµ„æº REST HTTP è·¯å¾„å‰ç¼€ä¸º <code>/apis</code>ï¼Œæ ¼å¼ä¸€å¾‹ä¸º <code>/apis/{group}/{version}</code>ï¼Œå¦‚ <code>/apis/apps/v1</code>ï¼Œ<code>/apis/autoscaling/v2</code></li>
</ul>
<p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨ kubectl æ“ä½œè¿™äº›èµ„æº (CRUD)</p>
<table>
<thead>
<tr>
<th>Pod</th>
<th>Deployment</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>kubectl run foo &ndash;image nginx</td>
<td>kubectl create deploy/foo &ndash;image nginx</td>
<td>create</td>
</tr>
<tr>
<td>kubectl create -f ./pod-nginx.yml</td>
<td>kubectl create -f ./deploy-nginx.yml</td>
<td>create</td>
</tr>
<tr>
<td>kubectl get pod foo</td>
<td>kubectl get  deploy foo</td>
<td>get</td>
</tr>
<tr>
<td>kubectl apply -f ./pod-foo.yml</td>
<td>kubectl apply -f ./deploy-foo.yml</td>
<td>update or create</td>
</tr>
<tr>
<td>kubectl delete pod foo</td>
<td>kubectl delete deploy foo</td>
<td>delete</td>
</tr>
</tbody>
</table>
<p>æ³¨æ„åˆ°ä¸éœ€è¦æŒ‡æ˜ Deployment å¯¹åº” Group apps ä¹Ÿå¯æ“ä½œæˆåŠŸï¼Œå› ä¸º kube-apiserver ä¸­å¹¶æ— å…¶ä»–åç§°å¤æ•°ä¸º deploys/deployments çš„èµ„æºã€‚å¦‚æœå¤šä¸ª Group å­˜åœ¨ç›¸åŒåå­—èµ„æºï¼Œåˆ™éœ€è¦é€šè¿‡ <code>{kind_plural}.{group}</code> å”¯ä¸€æ ‡è¯†èµ„æºï¼Œç±»ä¼¼è¿™æ · <code>kubectl get deployments.apps foo</code>ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¼€å§‹æ‹“å±• kube-apiserver APIï¼Œç›®æ ‡æ˜¯åœ¨å…¶ä¸­å¢è®¾ä¸€ä¸ªèµ„æºç»„ <code>hello.zeng.dev</code>ï¼ŒHTTP REST Path ä¸º <code>/apis/hello.zeng.dev/</code>ã€‚ä¸”èµ„æº <code>foos.hello.zeng.dev</code> å¯è¢« kubectl CRUD</p>
<table>
<thead>
<tr>
<th>by KindName</th>
<th>by GroupKindName</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>kubectl create -f ./foo.yml</td>
<td>kubectl create -f ./foo.yml</td>
<td>create</td>
</tr>
<tr>
<td>kubectl get foo myfoo</td>
<td>kubectl get hello.zeng.dev.foos myfoo</td>
<td>get</td>
</tr>
<tr>
<td>kubectl apply -f ./foos.yml</td>
<td>kubectl apply -f ./foos.yml</td>
<td>update or create</td>
</tr>
<tr>
<td>kubectl delete foo myfoo</td>
<td>kubectl delete hello.zeng.dev.foos myfoo</td>
<td>delete</td>
</tr>
</tbody>
</table>
<h2 id="-hands-on-api-by-crd">ğŸ® Hands on API by CRD</h2>
<p>æœ€ç®€å•çš„æ–¹å¼æ˜¯åœ¨é›†ç¾¤ä¸­åˆ›å»º CustomResourceDefinition å¯¹è±¡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">cat &lt;&lt; EOF | kubectl apply -f -</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiextensions.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CustomResourceDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># å›ºå®šæ ¼å¼ {kind_plural}.{group}ï¼Œå…¶ä¸­ foos å¯¹åº” spec.names.pluralï¼Œhello.zeng.dev å¯¹åº” spec.group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foos.hello.zeng.dev </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">hello.zeng.dev</span><span class="w"> </span><span class="c"># èµ„æºç»„ï¼Œç”¨åœ¨ URL æ ‡è¯†èµ„æºæ‰€å± Groupï¼Œå¦‚ /apis/hello.zeng.dev/v1/foos ä¹‹ hello.zeng.dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listKind</span><span class="p">:</span><span class="w"> </span><span class="l">FooList</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l">foos </span><span class="w"> </span><span class="c"># èµ„æºåå¤æ•°ï¼Œç”¨åœ¨ URL æ ‡è¯†èµ„æºç±»å‹ï¼Œå¦‚ /apis/hello.zeng.dev/v1/foos ä¹‹ foos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w"> </span><span class="c"># èµ„æºåå•æ•°ï¼Œå¯ç”¨äº kubectl åŒ¹é…èµ„æº</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shortNames</span><span class="p">:</span><span class="w">   </span><span class="c"># èµ„æºç®€ç§°ï¼Œå¯ç”¨äº kubectl åŒ¹é…èµ„æº</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">fo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">Namespaced</span><span class="w"> </span><span class="c"># Namespaced/Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">versions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># æ˜¯å¦å¯ç”¨è¯¥ç‰ˆæœ¬ï¼Œå¯ä½¿ç”¨è¯¥æ ‡è¯†å¯åŠ¨/ç¦ç”¨è¯¥ç‰ˆæœ¬ API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># å”¯ä¸€è½å­˜å‚¨ç‰ˆæœ¬ï¼Œå¦‚æœ CRD å«æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œåªèƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬è¢«æ ‡è¯†ä¸º true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">msg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">additionalPrinterColumns</span><span class="p">:</span><span class="w"> </span><span class="c"># å£°æ˜ kubectl get è¾“å‡ºåˆ—ï¼Œé»˜è®¤åœ¨ name åˆ—ä¹‹å¤–é¢å¤–è¾“å‡º age åˆ—ï¼Œæ”¹ä¸ºé¢å¤–è¾“å‡º age åˆ—ï¼Œmessage åˆ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.metadata.creationTimestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.spec.msg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º crd/foos.hello.zeng.dev ä¹‹åï¼Œå³å¯ç”¨ kubectl ç›´æ¥æ“ä½œ foo èµ„æºã€‚æ“ä½œä½“éªŒå’Œå®˜æ–¹èµ„æº Podï¼ŒService ç­‰ç›¸æ¯”å¹¶æ— äºŒè‡´ã€‚</p>
<img src="/img/2023/api-crd-crudfoo.gif" width="700px"/>
<h2 id="-api-discovery">ğŸ” API Discovery</h2>
<p>kubectl å¦‚ä½•çŸ¥é“ kube-apiserver å­˜åœ¨æŸé¡¹èµ„æº foï¼Ÿå¦‚ä½•çŸ¥é“ fo æ˜¯èµ„æº foos çš„ç®€ç§°ï¼Ÿå¦‚ä½•çŸ¥é“ foos å±äºå“ªä¸ªèµ„æº Groupï¼Ÿå¦‚ä½•çŸ¥é“ foos æ”¯æŒä»€ä¹ˆæ“ä½œï¼Ÿè¿™å°±æ¶‰åŠåˆ° Kubernetes çš„ API Discovery æœºåˆ¶ã€‚</p>
<p>è°ƒæ•´æ—¥å¿—çº§åˆ«å¯ä»¥å‘ç°ï¼škubectl åœ¨å‘ kube-apiserver å‘èµ· <code>GET /apis/hello.zeng.dev/v1/namespaces/default/foos</code> ä¹‹å‰ã€‚ä¼šå…ˆæŸ¥è¯¢ /api å’Œ /apis</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get fo --cache-dir <span class="k">$(</span>mktemp -d<span class="k">)</span> -v <span class="m">6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I0524 02:24:45.787217 <span class="m">1446906</span> loader.go:373<span class="o">]</span> Config loaded from file:  /root/.kube/config
</span></span><span class="line"><span class="cl">I0524 02:24:45.806835 <span class="m">1446906</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:41485/api?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">17</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 02:25:36.529247 <span class="m">1446951</span> round_trippers.go:463<span class="o">]</span> GET https://127.0.0.1:41485/apis?timeout<span class="o">=</span>32s
</span></span><span class="line"><span class="cl">I0524 02:24:45.829483 <span class="m">1446906</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:41485/apis/hello.zeng.dev/v1/namespaces/default/foos?limit<span class="o">=</span><span class="m">500</span> <span class="m">200</span> OK in <span class="m">5</span> milliseconds
</span></span><span class="line"><span class="cl">No resources found in default namespace.
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒæ•´ kubectl æ—¥å¿—çº§åˆ«ä¸º 8 æ‹¿åˆ° Accept Header æ›´æ”¹è¾“å‡º application/json -&gt; application/yamlï¼Œcurl kube-apiserver /apis</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on top terminal</span>
</span></span><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="c1"># on bottom terminal, Kubernetes 1.27.2</span>
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;Accept: application/yaml;g=apidiscovery.k8s.io;v=v2beta1;as=APIGroupDiscoveryList&#39;</span> localhost:8001/apis
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: apidiscovery.k8s.io/v2beta1
</span></span><span class="line"><span class="cl">kind: APIGroupDiscoveryList
</span></span><span class="line"><span class="cl">metadata: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">items:
</span></span><span class="line"><span class="cl">- metadata:
</span></span><span class="line"><span class="cl">    creationTimestamp: null
</span></span><span class="line"><span class="cl">    name: hello.zeng.dev
</span></span><span class="line"><span class="cl">  versions:
</span></span><span class="line"><span class="cl">  - version: v1
</span></span><span class="line"><span class="cl">    resources:
</span></span><span class="line"><span class="cl">    - resource: foos
</span></span><span class="line"><span class="cl">      responseKind:
</span></span><span class="line"><span class="cl">        group: hello.zeng.dev
</span></span><span class="line"><span class="cl">        kind: Foo
</span></span><span class="line"><span class="cl">        version: v1
</span></span><span class="line"><span class="cl">      scope: Namespaced
</span></span><span class="line"><span class="cl">      shortNames:
</span></span><span class="line"><span class="cl">      - fo
</span></span><span class="line"><span class="cl">      singularResource: foo
</span></span><span class="line"><span class="cl">      verbs:
</span></span><span class="line"><span class="cl">      - delete
</span></span><span class="line"><span class="cl">      - deletecollection
</span></span><span class="line"><span class="cl">      - get
</span></span><span class="line"><span class="cl">      - list
</span></span><span class="line"><span class="cl">      - patch
</span></span><span class="line"><span class="cl">      - create
</span></span><span class="line"><span class="cl">      - update
</span></span><span class="line"><span class="cl">      - watch
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ REST API ä¿¡æ¯</p>
<ul>
<li>kube-apiserver æœ‰ä¸€ä¸ª API Group <code>hello.zeng.dev</code></li>
<li>Group <code>hello.zeng.dev</code> å«æœ‰è®¸å¤š <code>versions</code></li>
<li>ç‰ˆæœ¬ <code>v1</code> å†…å«èµ„æº <code>foos</code>ï¼Œscope çº§åˆ«ä¸º <code>Namespaced</code></li>
<li><code>foos</code> èµ„æºç®€ç§°ä¸º <code>fo</code></li>
<li><code>foos</code> èµ„æºæ”¯æŒæ“ä½œåŠ¨è¯ä¸º <code>delete</code>, <code>deletecollection</code>, <code>get</code>, <code>list</code>, <code>patch</code>, <code>create</code>, <code>update</code>, <code>watch</code></li>
</ul>
<p>è·å–å¯¹åº” REST API ä¿¡æ¯åï¼Œkubectl å‘ç° fo æ˜¯èµ„æºå¤æ•°ä¸º <code>foos</code> çš„ç®€ç§°ï¼Œå…¶å¯¹åº” group ä¸º <code>hello.zeng.dev</code>ï¼Œå…¶é»˜è®¤ç‰ˆæœ¬ä¸º <code>v1</code>ï¼Œäºæ˜¯å‘èµ·è¯·æ±‚ <code>GET/POST/PATCH/DELETE /apis/hello.zeng.dev/v1/namespaces/default/foos</code>ï¼Œè€ŒæŠ›å‡ºé”™è¯¯ <code>error: the server doesn't have a resource type &quot;fo&quot;</code></p>
<p>âš ï¸ğŸ˜µ æ³¨æ„ ğŸ˜µâš ï¸</p>
<p>è¿”å›ç±»å‹ <code>application/yaml;g=apidiscovery.k8s.io;v=v2beta1;as=APIGroupDiscoveryList</code> ç”± <a href="https://github.com/kubernetes/enhancements/issues/3352">Feature Aggregated Discovery</a> å®ç°ï¼Œæ”¯æŒä¸€æ¬¡è°ƒç”¨è·å–æ‰€æœ‰ API Group/Resource ä¿¡æ¯ï¼Œäº 1.26 è¿›å…¥ alpha çŠ¶æ€ï¼ˆé»˜è®¤å…³é—­ï¼‰ï¼Œ1.27 è¿›å…¥ betaï¼ˆé»˜è®¤å¼€å¯ï¼‰</p>
<p>ä¸€èˆ¬åœ°ï¼Œkube-apiserver ä¸­æ‰€æœ‰ REST API resouces å‡å¯æŒ‰ç…§å¦‚ä¸‹å±‚æ¬¡å‘ç°ï¼ˆæ ¸å¿ƒ/é»˜è®¤ç»„æ”¾åœ¨ç‰¹æ®Šè·¯å¾„ <code>/api</code>ï¼Œå®ƒæ²¡æœ‰ Groupï¼ˆæˆ–è€…è¯´ Group æ˜¯ç©ºå­—ç¬¦ä¸²ï¼‰</p>
<ol>
<li>GET <code>/api</code> â¡ï¸ APIVersions or APIGroupDiscoveryList (1.27+)</li>
<li>GET <code>/apis</code> â¡ï¸ APIGroupList or APIGroupDiscoveryList (1.27+)</li>
<li>GET <code>/apis/{group}</code> â¡ï¸ APIGroup (optional, contained in <code>/apis</code>)</li>
<li>GET <code>/apis/{group}/{version}</code> or <code>/api/v1</code> â¡ï¸ APIResourceList</li>
</ol>
<p>kubectl api-resources åŒ…å«äº†æ•´ä¸ªå‘ç°è¿‡ç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Kubernetes 1.26.4 (1.27-</span>
</span></span><span class="line"><span class="cl">kubectl api-resources --cache-dir <span class="k">$(</span>mktemp -d<span class="k">)</span> -v <span class="m">6</span> <span class="p">|</span> awk <span class="s1">&#39;NR==1 || /pods|fo|deploy/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I0524 08:05:12.629151 <span class="m">1472208</span> loader.go:373<span class="o">]</span> Config loaded from file:  /root/.kube/config
</span></span><span class="line"><span class="cl">I0524 08:05:12.645780 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/api?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">14</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.650105 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">2</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.655089 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/authorization.k8s.io/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">3</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.655874 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/api/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">4</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.655935 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/authentication.k8s.io/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">4</span> milliseconds
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">I0524 08:05:12.659065 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/hello.zeng.dev/v1?timeout<span class="o">=</span>32s <span class="m">200</span> OK in <span class="m">6</span> milliseconds
</span></span><span class="line"><span class="cl">I0524 08:05:12.721295 <span class="m">1472208</span> round_trippers.go:553<span class="o">]</span> GET https://127.0.0.1:34779/apis/hello.zeng.dev/v1/namespaces/default/foos?limit<span class="o">=</span><span class="m">500</span> <span class="m">200</span> OK in <span class="m">43</span> milliseconds
</span></span><span class="line"><span class="cl">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND
</span></span><span class="line"><span class="cl">pods                              po           v1                                     <span class="nb">true</span>         Pod
</span></span><span class="line"><span class="cl">deployments                       deploy       apps/v1                                <span class="nb">true</span>         Deployment
</span></span><span class="line"><span class="cl">foos                              fo           hello.zeng.dev/v1                      <span class="nb">true</span>         Foo
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤æƒ…å†µä¸‹ kube-apiverser <code>GET /apis</code> è¿”å› APIGroupList (åŒ…å«æ‰€æœ‰ API Groups ä¿¡æ¯ï¼‰ï¼Œå†é€ä¸ªè®¿é—® <code>/apis/{group}/{version}</code> å¾—åˆ° APIResourceListã€‚æœ€ç»ˆæ±‡èšå‡º kube-apiserver æ”¯æŒçš„æ‰€æœ‰ Resource ä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on top terminal</span>
</span></span><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;Accept: application/yaml&#39;</span> localhost:8001/apis 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kind: APIGroupList
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">groups:
</span></span><span class="line"><span class="cl">- name: autoscaling
</span></span><span class="line"><span class="cl">  versions:
</span></span><span class="line"><span class="cl">  - groupVersion: autoscaling/v2
</span></span><span class="line"><span class="cl">    version: v2
</span></span><span class="line"><span class="cl">  - groupVersion: autoscaling/v1
</span></span><span class="line"><span class="cl">    version: v1
</span></span><span class="line"><span class="cl">  preferredVersion:
</span></span><span class="line"><span class="cl">    groupVersion: autoscaling/v2
</span></span><span class="line"><span class="cl">    version: v2
</span></span><span class="line"><span class="cl">- name: hello.zeng.dev
</span></span><span class="line"><span class="cl">  versions:
</span></span><span class="line"><span class="cl">  - groupVersion: hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">    version: v1
</span></span><span class="line"><span class="cl">  preferredVersion:
</span></span><span class="line"><span class="cl">    groupVersion: hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">    version: v1
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;Accept: application/yaml&#39;</span> localhost:8001/apis/hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">groupVersion: hello.zeng.dev/v1
</span></span><span class="line"><span class="cl">kind: APIResourceList
</span></span><span class="line"><span class="cl">resources:
</span></span><span class="line"><span class="cl">- kind: Foo
</span></span><span class="line"><span class="cl">  name: foos
</span></span><span class="line"><span class="cl">  namespaced: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  shortNames:
</span></span><span class="line"><span class="cl">  - fo
</span></span><span class="line"><span class="cl">  singularName: foo
</span></span><span class="line"><span class="cl">  storageVersionHash: <span class="nv">YAqgrOjs43I</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - delete
</span></span><span class="line"><span class="cl">  - deletecollection
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - patch
</span></span><span class="line"><span class="cl">  - create
</span></span><span class="line"><span class="cl">  - update
</span></span><span class="line"><span class="cl">  - watch
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºï¼ŒAPIGroupDiscoveryList å…¶å®æ˜¯ APIGroupList åŠ ä¸Šæ‰€æœ‰ APIResourceListï¼Œä½œç”¨æ˜¯å‡å°‘ API Discovery çš„è¯·æ±‚æ¬¡æ•° (n -&gt; 1)ã€‚</p>
<h2 id="-api-by-crd-internals">ğŸ¤” API by CRD internals</h2>
<p>kube-apiserver åŒ…å«ä¸¤ä¸ªæ¨¡å—ï¼škube-apiserver æ¨¡å—å’Œ <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a>ï¼Œå‰è€…è´Ÿè´£å®˜æ–¹æ ¸å¿ƒç»„ core/legacy (Pod, ConfigMap, Service ç­‰) å’Œå®˜æ–¹æ™®é€š Groups (apps, autoscaling, batch) èµ„æºçš„å¤„ç†ï¼Œåè€…è´Ÿè´£ CRD åŠå¯¹åº” Custom Resources å¤„ç†ã€‚</p>
<blockquote>
<p>ğŸ¤£ğŸ¤£ğŸ¤£
ã€Œkube-apiserver åŒ…å« kube-apiserver æ¨¡å—ã€ â€”â€” å¬ç€å¾ˆå¥‡æ€ªã€‚Kubernetes èµ·åˆåªæœ‰ kube-apiserver æ¨¡å—æä¾›å®˜æ–¹ APIï¼Œå¹¶ä¸æ”¯æŒ Custom Resourcesã€‚1.6 ä¹‹åç›¸ç»§å¼•å…¥ CustomResourceDefinitionsï¼ˆä¹Ÿå³ <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a>ï¼Œè§ <a href="https://github.com/kubernetes/enhancements/issues/95">issue 95</a>ï¼‰å’Œ kube-aggregator æ¨¡å—ï¼ˆæ”¯æŒ API Aggregation åŠŸèƒ½ï¼Œè§ <a href="https://github.com/kubernetes/enhancements/issues/263">issue 263</a>ï¼‰æ”¯æŒ Custom Resourcesã€‚</p>
</blockquote>
<p><a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a> åŠŸèƒ½ï¼Œç”±å¤šä¸ªå†…ç½® controllers é©±åŠ¨ã€‚æ¯”è¾ƒé‡è¦çš„æ§åˆ¶å™¨æ˜¯ controllers æ˜¯ <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/501bf5ec6db2f5e9171a8ed822380f71911b1b8f/pkg/apiserver/customresource_discovery_controller.go#L59">DiscoveryController</a>ï¼ˆè´Ÿè´£ API Discoveryï¼‰ã€OpenAPI æ§åˆ¶å™¨ï¼ˆOpenAPI Specï¼‰ï¼Œå’Œ <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a>ï¼ˆè´Ÿè´£èµ„æºçš„å¢åˆ æ”¹æŸ¥ï¼‰ã€‚å…¶ä»–çš„è¿˜æœ‰ CRD çŠ¶æ€å­—æ®µæ›´æ–°ã€å¯¹åº” custom resource åç§°æ£€æŸ¥ã€CRD åˆ é™¤æ¸…ç†ç­‰ï¼Œä»£ç é›†ä¸­åœ¨ <a href="https://github.com/kubernetes/apiextensions-apiserver/tree/master/pkg/controller">è¿™ä¸ª package</a>ã€‚</p>
<p><a href="https://github.com/kubernetes/apiextensions-apiserver/blob/501bf5ec6db2f5e9171a8ed822380f71911b1b8f/pkg/apiserver/customresource_discovery_controller.go#L59">DiscoveryController</a> å®ç°äº†ä¹‹å‰å±•ç¤ºçš„ API Discoveryã€‚å®ƒä¸æ–­ç›‘å¬ CRD å˜åŒ–ï¼Œè´Ÿè´£å°† CRD å£°æ˜åŒæ­¥è½¬åŒ–ä¸ºä»¥ä¸‹å†…å­˜å¯¹è±¡</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/apidiscovery/v2beta1/types.go#L33-L66">APIGroupDiscovery</a> (1.26+)</li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/0bff705acd8982e34b937116eb2016c9d6e4c4a6/staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/types.go#L1045-L1076">APIGroup</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/0bff705acd8982e34b937116eb2016c9d6e4c4a6/staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/types.go#L1098-L1155">APIResourceList</a></li>
</ul>
<p>å¹¶åŠ¨æ€æ³¨å†Œä»¥ä¸‹ API è¿”å›å¯¹åº”èµ„æº</p>
<ul>
<li><code>/apis/{group}</code> â¡ï¸ APIGroup</li>
<li><code>/apis/{group}/{version}</code> â¡ï¸ APIResourceList</li>
</ul>
<p>åœ¨æœ¬æ–‡ä¾‹å­ä¸­ï¼ŒåŠ¨æ€æ³¨å†Œçš„è·¯ç”±æ˜¯ <code>/apis/hello.zeng.dev</code> å’Œ <code>/apis/hello.zeng.dev/v1</code>ã€‚</p>
<p>åœ¨ 1.26+ APIGroupDiscovery åˆ™ä¼šæä¾›ç»™ kube-apiserver ä¸­çš„å…¨å±€ <a href="https://github.com/kubernetes/kubernetes/blob/b374404825125f5ea8c46313ccaf3717e6ba46fb/staging/src/k8s.io/apiserver/pkg/server/config.go#L278">AggregatedDiscoveryGroupManager</a>ï¼Œæœ€ç»ˆç»Ÿä¸€èšåˆåœ¨ <code>/apis</code>ã€‚1.26 ä¹‹å‰ï¼Œ<code>/apis</code> è·¯å¾„åªè¿”å› APIGroupListã€‚</p>
<p>å¾—ç›Šäº OpenAPI æ§åˆ¶å™¨ï¼ŒCRD åˆ›å»ºåï¼Œè‡ª kube-apiserver /openapi/v3 æˆ–è€… /openapi/v2 æŸ¥è¯¢ hello.zeng.dev/v1 çš„ OpenAPISpecï¼Œå³å¯å¾—åˆ°å¦‚ä¸‹ç»“æœï¼ˆåªå±•ç¤ºäº† 3 å±‚ JSONï¼Œå®Œæ•´å†…å®¹åœ¨ <a href="/file/hello.zeng.dev_v1_openapi_v3.json">è¿™é‡Œ</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on top terminal</span>
</span></span><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="c1"># on bottom terminal, or curl -s http://localhost:8001/openapi/v3/apis/hello.zeng.dev/v1 | jq &#39;del(.[]?[]?[]?[]?)&#39;</span>
</span></span><span class="line"><span class="cl">curl -s http://localhost:8001/openapi/v3/apis/hello.zeng.dev/v1 <span class="p">|</span> jq <span class="s1">&#39;delpaths([path(.), path(..) | select(length &gt;3)])&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;openapi&#34;</span>: <span class="s2">&#34;3.0.0&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;info&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;title&#34;</span>: <span class="s2">&#34;Kubernetes CRD Swagger&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;version&#34;</span>: <span class="s2">&#34;v0.1.0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;paths&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/apis/hello.zeng.dev/v1/foos&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;get&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;parameters&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;get&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;post&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;delete&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;parameters&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos/{name}&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;get&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;put&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;delete&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;patch&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;parameters&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;components&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;schemas&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;dev.zeng.hello.v1.Foo&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;dev.zeng.hello.v1.FooList&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.DeleteOptions&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.FieldsV1&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.ListMeta&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.ManagedFieldsEntry&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.ObjectMeta&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.OwnerReference&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Patch&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Preconditions&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Status&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.StatusCause&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.StatusDetails&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;io.k8s.apimachinery.pkg.apis.meta.v1.Time&#34;</span>: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OpenAPI æ§åˆ¶å™¨æœ‰ä¸¤ä¸ªï¼š<a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapi/controller.go">OpenAPIController v2</a> å’Œ <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapiv3/controller.go">OpenAPIController v3</a>ï¼Œåˆ†åˆ«æ”¯æŒ <a href="https://swagger.io/specification/v2/">OpenAPI Specification v2</a> å’Œ <a href="https://spec.openapis.org/oas/v3.1.0">OpenAPI Specification v3</a>ã€‚<strong>æ¥å£å“åº”ä½“å­—æ®µ</strong> schemas å¯¹åº” CRD å¯¹è±¡å­—æ®µ <code>.spec.versions[].schema</code>ï¼Œ <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapi/controller.go">OpenAPIController v2</a> å’Œ <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/controller/openapiv3/controller.go">OpenAPIController v3</a> ä¼šç›‘å¬ CRD å˜åŒ–ã€è‡ªåŠ¨ç”Ÿæˆ OpenAPISpec å¹¶å°†å…¶å†™å…¥ kube-apiserver æ¨¡å— OpenAPI Specï¼Œç”± kube-apiserver è·¯ç”± /openapi/v2 å’Œ /openapi/v3 å¯¹å¤–æš´éœ²ã€‚</p>
<p>OpenAPISpec åˆ™ç±»ä¼¼ä½¿ç”¨è¯´æ˜ä¹¦ï¼Œå®ƒæä¾›äº†ä½¿ç”¨ API çš„è§„èŒƒï¼šåŒ…æ‹¬æ¥æ”¶å‚æ•°ã€æ•°æ®æ ¼å¼çº¦æŸã€æ“ä½œåŠ¨è¯ã€è¿”å›æ•°æ®ç±»å‹ç­‰ã€‚ç¨å¾®ä¿®æ”¹ CRD OpenAPI å®šä¹‰ï¼Œè¦æ±‚ <code>spec.msg</code> ä¸ºå¿…è¾“ï¼Œä¸”é•¿åº¦ä¸è¶…è¿‡ 15</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;msg&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># æ–°å¢å­—æ®µå¿…è¾“æ ¡éªŒ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">msg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">maxLength</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="c"># æ–°å¢é•¿åº¦ä¸Šé™æ ¡éªŒ</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¯æ ¡éªŒæ•ˆæœå¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | k apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: hello.zeng.dev/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Foo
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: invalid
</span></span></span><span class="line"><span class="cl"><span class="s">spec: {}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The Foo <span class="s2">&#34;invalid&#34;</span> is invalid: spec.msg: Required value
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | k apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: hello.zeng.dev/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Foo
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: invalid
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  msg: &#34;hello world, hello world&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">The Foo <span class="s2">&#34;invalid&#34;</span> is invalid: spec.msg: Too long: may not be longer than <span class="m">15</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/img/2023/crd-custom-resource-validation.gif" width="600px"/>
<p>æ­¤å¤–å¯ä»¥çœ‹åˆ°ï¼Œåˆ›å»º Foo ä¸éµä»å¦‚ä¸‹ç»“æ„ä¼šæŠ¥é”™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: hello.zeng.dev/v1 | apiVersion: v1  &lt;--- ä½¿ç”¨ä½•ç§ API ç‰ˆæœ¬åˆ›å»ºèµ„æº
</span></span><span class="line"><span class="cl">kind: Foo                     | kind: Pod       &lt;--- æ¬²åˆ›å»ºèµ„æºç±»å‹
</span></span><span class="line"><span class="cl">metadata:                     | metadata:       &lt;--- å”¯ä¸€æ ‡è¯†èµ„æºçš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ name
</span></span><span class="line"><span class="cl">  name: myfoo                 |   name: web              namespaceï¼ˆé»˜è®¤å€¼ä¸º defaultï¼‰, UIDï¼ˆçœç•¥åˆ™åœ¨æœåŠ¡ç«¯è‡ªåŠ¨ç”Ÿæˆ) ç­‰
</span></span><span class="line"><span class="cl">spec:                         | spec:           &lt;--- æ‰€æœŸæœ›çš„èµ„æºçŠ¶æ€ï¼ˆWhat state you desire for the object
</span></span><span class="line"><span class="cl">  msg: hi                     |   containers:            é€šå¸¸æ­é… status ä½¿ç”¨ï¼Œå½“å‰é˜¶æ®µçš„ Foo è¿˜ä¸æ¶‰åŠï¼Œåç»­æ–‡ç« ä¼šåšä»‹ç»
</span></span><span class="line"><span class="cl">                              |   - name: nginx  
</span></span><span class="line"><span class="cl">                              |     image: nginx
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒä»¬æ˜¯ <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/#required-fields">Kubernetes objects å¿…é¡»å­—æ®µ</a> ã€‚å°½ç®¡ CRD OpenAPIV3 Schema å¹¶ä¸åŒ…å« apiVersion, kind å’Œ metadata å­—æ®µï¼Œ <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a> ä¼š <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/e0b0416bf23396ad7fb7007b264f5c04062590bc/pkg/registry/customresource/validator.go">å¼ºåˆ¶ä¿è¯è¿™äº›å­—æ®µ</a>ã€‚</p>
<p>ğŸª¬ğŸª¬ğŸª¬ Kubernetes 1.25+ <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation-rules">CRD validation rules</a> è¿›å…¥ betaï¼Œå¯åœ¨ OpenAPI Spec åŸºç¡€ä¸Šè®¾ç½®æ›´å¼ºå¤§çš„å­—æ®µçº¦æŸã€‚</p>
<p>ğŸª¬ğŸª¬ğŸª¬ kubectl apply ä¼šåˆ©ç”¨ OpenAPI Spec ç¡®å®šèµ„æºæ”¯æŒçš„ Patch ç±»å‹ï¼Œkubectl explain è¾“å‡ºçš„èµ„æºå­—æ®µæ¥è‡ªäº OpenAPI Specã€‚kubectl æ’ä»¶ <a href="https://github.com/kubernetes-sigs/kubectl-validate">kubernetes-sigs/kubectl-validate</a> æ”¯æŒåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ OpenAPI Spec æ ¡éªŒèµ„æºå¯¹è±¡ï¼ˆæ¥è¿‘ <code>--dry-run=server</code>ï¼‰ã€‚</p>
<p>è§£é‡Šäº† API Discovery å¦‚ä½•å¯èƒ½å’Œå¦‚ä½•ä½¿ç”¨ API ä¹‹åï¼Œåˆ°è¾¾äº†æœ€åä¸€ä¸ªé—®é¢˜ï¼š<strong>API èµ„æºå¤„ç†å’ŒæŒä¹…å¦‚ä½•å¯èƒ½?</strong></p>
<p>è¿™å¾—ä»è·¯ç”±å±‚è¯´èµ·ï¼Œkube-apiserver <a href="https://github.com/kubernetes/kubernetes/blob/e11c5284ad01554b60c29b8d3f6337f2c735e7fb/cmd/kube-apiserver/app/server.go#L192-L208">é€šè¿‡å§”æ‰˜æ¨¡å¼ä¸²è” apiextensions-apiserver æ¨¡å—</a> è·å¾—äº† CRD å¤„ç†èƒ½åŠ›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kube-apiserver ---&gt; {core/legacy group /api/**}, {official groups /apis/apps/**, /apis/batch/**, ...}
</span></span><span class="line"><span class="cl">    â”‚
</span></span><span class="line"><span class="cl"> delegate
</span></span><span class="line"><span class="cl">    â”‚
</span></span><span class="line"><span class="cl">    â””â”€â”€ apiextensions-apiserver ---&gt; {CRD groups /apis/apiextensions.k8s.io/**, /apis/&lt;crd.group.io&gt;/**}
</span></span><span class="line"><span class="cl">                      â”‚
</span></span><span class="line"><span class="cl">                   delegate
</span></span><span class="line"><span class="cl">                      â”‚
</span></span><span class="line"><span class="cl">                      â””â”€â”€ notfoundhandler ---&gt; 404 NotFound
</span></span></code></pre></td></tr></table>
</div>
</div><p>HTTP è¯·æ±‚è·¯ç”±æµç¨‹å¦‚ä¸‹</p>
<ul>
<li>å…ˆä» kube-apiserver æ¨¡å—å¼€å§‹è·¯ç”±åŒ¹é…ï¼Œå¦‚æœåŒ¹é…æ ¸å¿ƒç»„è·¯ç”± <code>/api/**</code> æˆ–è€…<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.27/#-strong-api-groups-strong-">å®˜æ–¹ API Groups</a> å¦‚ <code>/apis/apps/**</code>ï¼Œ<code>/apis/batch/**</code>ï¼Œç›´æ¥åœ¨æœ¬æ¨¡å—å¤„ç†ã€‚å¦‚æœä¸åŒ¹é…ï¼Œå§”æ‰˜ç»™ apiextensions-apiserver å¤„ç†</li>
<li><a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a> å…ˆçœ‹è¯·æ±‚æ˜¯å¦åŒ¹é…è·¯ç”± <code>/apis/apiextensions.k8s.io/**</code>ï¼Œå¦‚æœæ˜¯åˆ™ä¸º customresourcedefinitions å˜æ›´ï¼Œç›´æ¥åœ¨æœ¬æ¨¡å—å¤„ç†ï¼›å¦‚æœä¸åŒ¹é…ï¼Œå†çœ‹æ˜¯å¦åŒ¹é…ä»»æ„ CRD å¯¹åº”çš„ Custom è·¯ç”± <code>/apis/{crd_group}/**</code>ï¼Œå¦‚æœä»»ä¸€åŒ¹é…ï¼Œç›´æ¥åœ¨æœ¬æ¨¡å—å¤„ç†ã€‚å¦åˆ™å§”æ‰˜ç»™ notfoundhandler å¤„ç†</li>
<li>notfoundhandler è¿”å› HTTP 404</li>
</ul>
<p>å›é¡¾ä¹‹å‰çš„ OpenAPI Specï¼Œå¯ä»¥å‘ç° <a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a> è‡ªåŠ¨ä¸º CRD ç”Ÿæˆäº†è¿™äº› REST API</p>
<ul>
<li>/apis/hello.zeng.dev/v1/foos</li>
<li>/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos</li>
<li>/apis/hello.zeng.dev/v1/namespaces/{namespace}/foos/{name}</li>
</ul>
<p>åŸç†æ˜¯æ¨¡å—å†… <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a> æä¾›äº† <code>/apis/{group}/{version}/({kind_plural} | namespaces/{namespace}/{kind_plural} | namespaces/{namespace}/{kind_plural}/{name})</code> é€šé…ã€‚<a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a> å®æ—¶è¯»å–æ‰€æœ‰ CRD ä¿¡æ¯ï¼Œè´Ÿè´£ custom resources çš„ CRUD æ“ä½œï¼Œå¹¶æŒæœ‰ä¸€ä¸ª <a href="https://github.com/kubernetes/apiextensions-apiserver/tree/master/pkg/registry/customresource">RESTStorage</a> (å®ç°é€šå¸¸ä¸º etcd)ã€‚åœ¨ API å±‚ä¸šåŠ¡ï¼ˆé€šç”¨æ ¡éªŒã€è§£ç è½¬æ¢ã€admission ç­‰ï¼‰æˆåŠŸåï¼Œ<a href="https://github.com/kubernetes/apiextensions-apiserver/blob/master/pkg/apiserver/customresource_handler.go">customresource_handler</a> è°ƒç”¨ RESTStorage å®æ–½å¯¹è±¡æŒä¹…åŒ–ã€‚</p>
<p>è·¯ç”± <code>/apis</code> å®é™…æ˜¯ <code>/apis/{group}/{version}</code> å’Œ <code>/apis/{group}</code> çš„èšåˆï¼Œç”± kube-apiserver çš„ kube-aggregator æ¨¡å—æä¾›ï¼Œå°†åœ¨åé¢ç« èŠ‚ä»‹ç»ã€‚</p>
<p>æ€»ç»“ä¸Šè¿°å†…å®¹å¦‚ä¸‹</p>
<img src="/img/2023/crd-2discovery-2resource.png" width="888px"/>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">                      +--- DiscoveryController sync ---&gt; HTTP Endpoints /apis/{group},/apis/{group}/{version}
</span></span><span class="line"><span class="cl">                      |
</span></span><span class="line"><span class="cl">CRD &lt;---listwatch---&gt; +--- OpenApiController sync ---&gt; OpenAPI Spec in kube-apiserver module
</span></span><span class="line"><span class="cl">                      |
</span></span><span class="line"><span class="cl">                      +--- customresource_handler CRUDs
</span></span><span class="line"><span class="cl">                           +---&gt; /apis/{group}/{version}/foos
</span></span><span class="line"><span class="cl">                           +---&gt; /apis/{group}/{version}/namespaces/{namespace}/{kind_plural}
</span></span><span class="line"><span class="cl">                           +---&gt; /apis/{group}/{version}/namespaces/{namespace}/{kind_plural}/{name}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="-generate-crd-from-go-structs">ğŸ§° Generate CRD from Go Structs</h2>
<p>æ‰‹åŠ¨ç»´æŠ¤ CRD å¯¹è±¡æ˜¯ç¬¨åŠæ³•ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯ä» Go Struct ç”Ÿæˆ CRD å£°æ˜ã€‚<a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a> é¡¹ç›®çš„ä¸€ä¸ªå·¥å…· <a href="https://github.com/kubernetes-sigs/controller-tools/tree/master/cmd/controller-gen">controller-gen</a> æä¾›äº†è¿™ç§èƒ½åŠ›ã€‚</p>
<p>æˆ‘çš„é¡¹ç›® <a href="https://github.com/phosae/x-kubernetes">x-kubernetes</a> ç»Ÿä¸€å°† API ç›¸å…³ Go Structs æ”¾ç½®åœ¨ç›®å½• /api ä¸­ï¼ŒæŒ‰ç…§ /api/{group} ç½—åˆ—</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">~/x-kubernetes# tree api -L 3
</span></span><span class="line"><span class="cl">api
</span></span><span class="line"><span class="cl">â””â”€â”€ hello.zeng.dev
</span></span><span class="line"><span class="cl">    â””â”€â”€ v1
</span></span><span class="line"><span class="cl">        â”œâ”€â”€ types.go
</span></span><span class="line"><span class="cl">        â””â”€â”€ ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>types.go å†…å®¹å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">v1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Foo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">Spec</span> <span class="nx">FooSpec</span> <span class="s">`json:&#34;spec&#34; protobuf:&#34;bytes,2,opt,name=spec&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">FooSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Msg says hello world!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Msg</span> <span class="kt">string</span> <span class="s">`json:&#34;msg&#34; protobuf:&#34;bytes,1,opt,name=msg&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Msg1 provides some verbose information
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Msg1</span> <span class="kt">string</span> <span class="s">`json:&#34;msg1&#34; protobuf:&#34;bytes,2,opt,name=msg1&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">FooList</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ListMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">Items</span> <span class="p">[]</span><span class="nx">Foo</span> <span class="s">`json:&#34;items&#34; protobuf:&#34;bytes,2,rep,name=items&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨é¡¹ç›® /api ç›®å½•ï¼Œæ‰§è¡Œ crd ç”Ÿæˆè„šæœ¬ update-crd-docker.sh</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~/x-kubernetes/api# ./hack/update-crd-docker.sh 
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…åœ¨ /api ç›®å½•ç›´æ¥è·‘ controller-gen</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">controller-gen schemapatch:manifests<span class="o">=</span>./artifacts/crd <span class="nv">paths</span><span class="o">=</span>./... output:dir<span class="o">=</span>./artifacts/crd
</span></span></code></pre></td></tr></table>
</div>
</div><p>å³å¯åŠ¨æ€ç”Ÿæˆ OpenAPI schemas (changes trace: git diff a5469c0 38dcc40 -- artifacts/crd/hello.zeng.dev_foos.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiextensions.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CustomResourceDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foos.hello.zeng.dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">hello.zeng.dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listKind</span><span class="p">:</span><span class="w"> </span><span class="l">FooList</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l">foos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">Namespaced</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">versions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">additionalPrinterColumns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">age</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.metadata.creationTimestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.spec.msg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">message1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="l">.spec.msg1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="w">       </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+        openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+          type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+          required</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">+            - spec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+          properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            apiVersion</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              description: &#39;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info</span><span class="p">:</span><span class="w"> </span><span class="l">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            kind</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              description: &#39;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info</span><span class="p">:</span><span class="w"> </span><span class="l">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+            spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              required</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">+                - msg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+              properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                msg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  description</span><span class="p">:</span><span class="w"> </span><span class="l">Msg says hello world!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                msg1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  description</span><span class="p">:</span><span class="w"> </span><span class="l">Msg1 provides some verbose information</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">+                  type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥å‘ç° Go Structs ä¸­å«æœ‰ JSON Tags çš„å­—æ®µå‡è¢«æ˜ å°„åˆ°äº† OpenAPI Spec Propertiesï¼Œå­—æ®µæ³¨é‡Šæ˜ å°„åˆ°äº† descriptionï¼Œå­—æ®µç±»å‹æ˜ å°„åˆ°äº† typeã€‚</p>
<p>âš ï¸âš ï¸âš ï¸ æ³¨æ„ï¼šè¿™é‡Œçš„ <code>controller-gen schemapatch</code>ï¼Œä½œç”¨ä½¿ç”¨ patch ä»…æ›´æ–°æ–‡ä»¶ hello.zeng.dev_foos.yaml ä¸­çš„ openAPIV3Schemaã€‚å¦‚æœä½¿ç”¨ <code>controller-gen crd</code>ï¼Œåˆ™ä¼šé‡æ–°ç”Ÿæˆæ•´ä¸ªæ–‡ä»¶ã€‚</p>
<ul>
<li><code>controller-gen crd:crdVersions=v1 paths=./... output:dir=./artifacts/crd</code> ç”Ÿæˆå®Œæ•´CRDå®šä¹‰ â¡ï¸ <a href="https://github.com/phosae/x-kubernetes/blob/38dcc4056984705ffbf9dbeaa570e875857a6042/api/artifacts/crd/hello.zeng.dev_foos_full.yaml">hello.zeng.dev_foos_full.yaml</a></li>
<li><code>controller-gen crd:crdVersions=v1,maxDescLen=0 paths=./... output:dir=./artifacts/crd</code> ç”Ÿæˆä¸å«æ³¨é‡Šçš„CRDå®šä¹‰ â¡ï¸ <a href="https://github.com/phosae/x-kubernetes/blob/38dcc4056984705ffbf9dbeaa570e875857a6042/api/artifacts/crd/hello.zeng.dev_foos_nodesc.yaml">hello.zeng.dev_foos_nodesc.yaml</a></li>
</ul>
<p>è¿™é‡Œæ²¡æœ‰å¼•å…¥éœ€è¦å­¦ä¹ æˆæœ¬çš„ <a href="https://book.kubebuilder.io/reference/markers/crd.html">generation markers</a>ï¼Œæ•…æ²¡æ³•ç”Ÿæˆ additionalPrinterColumns å®šä¹‰ã€‚ä¹Ÿæ²¡æœ‰å¼•å…¥ <a href="https://book.kubebuilder.io/reference/markers/crd-validation.html">validation markers</a>ï¼Œæ•…æ²¡æ³•ç”Ÿæˆå­—æ®µæ ¡éªŒ schemaã€‚</p>
<p>âš ï¸âš ï¸âš ï¸ æ³¨æ„ï¼šCRD OpenAPI Schema ä¹‹ <code>properties/apiVersion, kind, metadata</code> ï¼Œè™½ç„¶å·¥å…·ç”Ÿæˆäº†è¿™äº›å­—æ®µå®šä¹‰ï¼Œå®é™…éå¿…éœ€ï¼ˆå¦‚ä¹‹å‰å±•ç¤ºï¼‰ã€‚apiextensions-apiserver çš„ <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/37c0f7d353bee5630da4b697c410b00acec91f11/pkg/controller/openapi/builder/builder.go#L381-L413">openapi builder</a> ä¼šè‡ªåŠ¨æ³¨å…¥è¿™äº›å®šä¹‰ã€‚</p>
<h2 id="-summarize">ğŸ“ Summarize</h2>
<p>CustomResourceDefinition æ˜¯æ‹“å±• K8s API æœ€ä¾¿æ·æ–¹å¼ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚<a href="https://github.com/kubernetes/apiextensions-apiserver">apiextensions-apiserver æ¨¡å—</a> æœ‰å¦‚ä¸‹å¥½å¤„</p>
<ul>
<li>å¼€ç®±å³ç”¨ï¼Œåªéœ€æä¾› CRD å£°æ˜ï¼Œä¸éœ€è¦è‡ªè¡Œå®ç° REST APIï¼ˆåŒ…æ‹¬ OpenAPI Spec è½¬æ¢ã€API Discoveryã€Custom Resource CRUDï¼‰ï¼Œä¹Ÿä¸éœ€è¦ä¸å­˜å‚¨å±‚äº¤äº’</li>
<li>æœ¬èº«é›†æˆåœ¨ kube-apiserver ä¸­ï¼Œä¸éœ€è¦å¤„ç†é‰´æƒï¼ˆauthenticationï¼‰å’Œæˆæƒï¼ˆauthorizationï¼‰</li>
<li><a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>, <a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a> ç­‰ç¤¾åŒºå·¥å…·ï¼Œå¯ä»¥ä¸€é”®ç”Ÿæˆ CRD å®šä¹‰å’Œå¯¹åº”çš„æ§åˆ¶å™¨è„šæ‰‹æ¶</li>
</ul>
<p>è€Œå®ƒçš„ç¼ºç‚¹ä¹Ÿæ­£æ˜¯å®ƒçš„ä¼˜ç‚¹çš„åé¢ï¼ˆä½†å¯¹äºè§„æ¨¡ä¸å¤§çš„é›†ç¾¤å’Œå¤§éƒ¨åˆ†åœºæ™¯é€šå¸¸å¯ä»¥å¿å—</p>
<ul>
<li>å­˜å‚¨é™åˆ¶è¾ƒå¤§ï¼Œåªèƒ½ä»¥ JSON å­˜å‚¨ etcdï¼Œå…¶ä»–å­˜å‚¨éœ€æ±‚æ— æ³•æ»¡è¶³ï¼Œæ¯”å¦‚å­˜å‚¨ä¸º protobuf ä»¥èŠ‚çº¦ç£ç›˜ç©ºé—´ï¼Œæ¯”å¦‚ Custom Resource ä»…å­˜å‚¨åœ¨å†…å­˜ï¼Œä»…å­˜å‚¨åœ¨æ™®é€šæ–‡ä»¶ï¼Œéœ€è¦å­˜å‚¨åœ¨ MySQL, SQLite, PostgreSQL ç­‰å…³ç³»å‹æ•°æ®åº“</li>
<li>API ç»‘å®šåœ¨ kube-apiserver è¿›ç¨‹ï¼Œæ— æ³•å•ç‹¬å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ— æ³•å®æ–½ API åˆ†æµï¼Œå®šåˆ¶æ€§ä½</li>
</ul>
<p>åç»­ç¯‡ç« ä¼šåŸºäºåŒæ ·çš„ API åº“ï¼Œå±•ç¤ºå„ç§ custom apiserver é›†æˆæ–¹å¼ï¼Œæ–¹ä¾¿æ¯”è¾ƒä¼˜åŠ£ã€‚</p>
<p>Custom API å¾€å¾€éœ€è¦é…åˆæ§åˆ¶å™¨ï¼Œæ‰èƒ½å‘æŒ¥å…¶å¼ºå¤§èƒ½åŠ›ã€‚æœ¬æ–‡ä»…ä»‹ç»äº† CustomResourceDefinition çš„ä½¿ç”¨å§¿åŠ¿å’Œå®ç°åŸç†ã€‚æ§åˆ¶å™¨ç›¸å…³å°†åœ¨åç»­ç¯‡ç« ä»‹ç»ã€‚</p>
<!-- apiextensions-apiserver timeline -->
<!-- API Aggregation timeline -->

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Zeng Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-05-27 17:29
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">æœ¬ä½œå“é‡‡ç”¨ <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®®</a> è¿›è¡Œè®¸å¯ï¼Œè½¬è½½æ—¶è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ã€‚</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/rest/">rest</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2023-k8s-apiserver-from-scratch/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">å®ç°ä¸€ä¸ªæç®€ K8s apiserver</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2023-kubeadm-enable-kubelet-serving-certs/">
            <span class="next-text nav-default">Enable Kubelet Serving Certificates in Kubernetes Setup by Kubeadmin</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2023-05-19 10:09:09 \u002b0800 CST',
        title: 'K8s CustomResourceDefinitions (CRD) åŸç†',
        clientID: '6ab3c721bb197ea92f1e',
        clientSecret: '217d38cc1905f60f1d963c555be606ed3e707937',
        repo: 'phosae.github.io',
        owner: 'phosae',
        admin: ['phosae'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zenngxu@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/phosae" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/u/1566013967" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://www.zeng.dev/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zeng Xu</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-FEPN2KZF84', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>










</body>
</html>
